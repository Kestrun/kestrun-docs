---
layout: default
parent: Sessions
grand_parent: PowerShell Tutorials
title: Sessions with Redis
nav_order: 2
---

# Sessions with Redis

Use StackExchange.Redis as the distributed cache backing for ASP.NET Core session state.

## Full source

File: [`pwsh/tutorial/examples/19.2-Sessions-Redis.ps1`][19.2-Sessions-Redis.ps1]

```powershell
{% include examples/pwsh/19.2-Sessions-Redis.ps1 %}
```

## Step-by-step

1. Logging: Register a console logger and set level to Debug.
2. Server: Create a Kestrun server named "Sessions Demo Server".
3. Listener: Listen on loopback using a self-signed certificate on the provided port (HTTPS).
4. Cookie: Build a secure session cookie (`Kr.Session`) with HttpOnly, SameSite=Lax, and SecurePolicy=Always.
5. Redis cache: Configure Redis using `Add-KrDistributedRedisCache -Configuration 'localhost:6379' -InstanceName 'KestrunSession_'`.
6. Session: Enable session services and middleware with idle (20s) and I/O (10s) timeouts.
7. Configure: Call `Enable-KrConfiguration` to build the app.
8. Routes: Map endpoints for counter, login, whoami, logout, set, and get using session cmdlets.
9. Start: Run the server asynchronously with `Start-KrServer`.

## Try it

Because this sample uses a self-signed certificate and a Secure cookie, use HTTPS and skip certificate verification during local testing.

```powershell
$base = 'https://127.0.0.1:5000'

# Counter increments with the same cookie jar
curl -k -s -c jar.txt -b jar.txt "$base/session/counter" | jq
curl -k -s -c jar.txt -b jar.txt "$base/session/counter" | jq

# WhoAmI requires login
curl -k -s -c jar.txt -b jar.txt -i "$base/session/whoami"

# Login and read identity
curl -k -s -c jar.txt -b jar.txt "$base/session/login?user=max" | jq
curl -k -s -c jar.txt -b jar.txt "$base/session/whoami" | jq

# Generic set/get within the same session
curl -k -s -c jar.txt -b jar.txt "$base/session/set?key=color&value=purple" | jq
curl -k -s -c jar.txt -b jar.txt "$base/session/get?key=color" | jq

# Logout clears the session
curl -k -s -c jar.txt -b jar.txt "$base/session/logout" | jq
curl -k -s -c jar.txt -b jar.txt -i "$base/session/whoami"
```

PowerShell equivalents (Invoke-WebRequest):

```powershell
$base = 'https://127.0.0.1:5000'
$sess = New-Object Microsoft.PowerShell.Commands.WebRequestSession

# Counter increments with the same WebRequestSession
((Invoke-WebRequest -Uri "$base/session/counter" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json).counter
((Invoke-WebRequest -Uri "$base/session/counter" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json).counter

# WhoAmI requires login (expected 401 before login)
try {
    Invoke-WebRequest -Uri "$base/session/whoami" -WebSession $sess -SkipCertificateCheck -ErrorAction Stop | Out-Null
} catch {
    'status: 401 (unauthorized)'
}

# Login and read identity
Invoke-WebRequest -Uri "$base/session/login?user=max" -WebSession $sess -SkipCertificateCheck | Out-Null
(Invoke-WebRequest -Uri "$base/session/whoami" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json

# Generic set/get within the same session
Invoke-WebRequest -Uri "$base/session/set?key=color&value=purple" -WebSession $sess -SkipCertificateCheck | Out-Null
(Invoke-WebRequest -Uri "$base/session/get?key=color" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json

# Logout clears the session
Invoke-WebRequest -Uri "$base/session/logout" -WebSession $sess -SkipCertificateCheck | Out-Null
try {
    Invoke-WebRequest -Uri "$base/session/whoami" -WebSession $sess -SkipCertificateCheck -ErrorAction Stop | Out-Null
} catch {
    'status: 401 (unauthorized)'
}
```

> Tip: Keep Redis running locally (e.g., Docker) and ensure connectivity with your configuration string.

## Key Points

- Use Redis for scale-out session storage across multiple instances.
- The sample demonstrates `Add-KrDistributedRedisCache` plus `Add-KrSession`.
- Cookie settings matter in production: Secure, HttpOnly, SameSite.
- Session must be enabled before routes that depend on it.

## Troubleshooting

- Connection refused: Verify Redis is running and your connection string is correct.
- Session not persisting: Confirm the cookie is preserved and the server process can reach Redis.
- Timeouts: Tune Redis and session timeouts based on workload.

## References

- [Add-KrDistributedRedisCache][Add-KrDistributedRedisCache]
- [Add-KrSession][Add-KrSession]
- [New-KrCookieBuilder][New-KrCookieBuilder]
- [Get-KrSessionInt32][Get-KrSessionInt32]
- [Set-KrSessionInt32][Set-KrSessionInt32]
- [Get-KrSessionString][Get-KrSessionString]
- [Set-KrSessionString][Set-KrSessionString]
- [Clear-KrSession][Clear-KrSession]
- [Sessions Guide][Sessions Guide]

---

### Previous / Next

Previous: [Sessions](./1.Sessions.md)
Next: [Sessions with SQL Server](./3.Sessions-Sql.md)

[19.2-Sessions-Redis.ps1]: /pwsh/tutorial/examples/19.2-Sessions-Redis.ps1
[Add-KrDistributedRedisCache]: /pwsh/cmdlets/Add-KrDistributedRedisCache
[Add-KrSession]: /pwsh/cmdlets/Add-KrSession
[New-KrCookieBuilder]: /pwsh/cmdlets/New-KrCookieBuilder
[Get-KrSessionInt32]: /pwsh/cmdlets/Get-KrSessionInt32
[Set-KrSessionInt32]: /pwsh/cmdlets/Set-KrSessionInt32
[Get-KrSessionString]: /pwsh/cmdlets/Get-KrSessionString
[Set-KrSessionString]: /pwsh/cmdlets/Set-KrSessionString
[Clear-KrSession]: /pwsh/cmdlets/Clear-KrSession
[Sessions Guide]: /topics/sessions
