---
layout: default
parent: Sessions
grand_parent: PowerShell Tutorials
title: Sessions with SQL Server
nav_order: 3
---

# Sessions with SQL Server

Use SQL Server as the distributed cache backing for ASP.NET Core session state.

## Full source

File: [`pwsh/tutorial/examples/19.3-Sessions-Sql.ps1`][19.3-Sessions-Sql.ps1]

```powershell
{% include examples/pwsh/19.3-Sessions-Sql.ps1 %}
```

## Step-by-step

1. Logging: Register a console logger and set level to Debug.
2. Server: Create a Kestrun server named "Sessions Demo Server".
3. Listener: Listen on loopback using a self-signed certificate on the provided port (HTTPS).
4. Cookie: Build a secure session cookie (`Kr.Session`) with HttpOnly, SameSite=Lax, and SecurePolicy=Always.
5. SQL cache: Configure SQL Server using `Add-KrDistributedSqlServerCache -ConnectionString ... -SchemaName dbo -TableName Sessions`.
6. Session: Enable session services and middleware with idle (20s) and I/O (10s) timeouts.
7. Configure: Call `Enable-KrConfiguration` to build the app.
8. Routes: Map endpoints for counter, login, whoami, logout, set, and get using session cmdlets.
9. Start: Run the server asynchronously with `Start-KrServer`.

## Try it

Because this sample uses a self-signed certificate and a Secure cookie, use HTTPS and skip certificate verification during local testing.

```powershell
$base = 'https://127.0.0.1:8080'

# Counter increments with the same cookie jar
curl -k -s -c jar.txt -b jar.txt "$base/session/counter" | jq
curl -k -s -c jar.txt -b jar.txt "$base/session/counter" | jq

# WhoAmI requires login
curl -k -s -c jar.txt -b jar.txt -i "$base/session/whoami"

# Login and read identity
curl -k -s -c jar.txt -b jar.txt "$base/session/login?user=max" | jq
curl -k -s -c jar.txt -b jar.txt "$base/session/whoami" | jq

# Generic set/get within the same session
curl -k -s -c jar.txt -b jar.txt "$base/session/set?key=color&value=purple" | jq
curl -k -s -c jar.txt -b jar.txt "$base/session/get?key=color" | jq

# Logout clears the session
curl -k -s -c jar.txt -b jar.txt "$base/session/logout" | jq
curl -k -s -c jar.txt -b jar.txt -i "$base/session/whoami"
```

PowerShell equivalents (Invoke-WebRequest):

```powershell
$base = 'https://127.0.0.1:8080'
$sess = New-Object Microsoft.PowerShell.Commands.WebRequestSession

# Counter increments with the same WebRequestSession
((Invoke-WebRequest -Uri "$base/session/counter" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json).counter
((Invoke-WebRequest -Uri "$base/session/counter" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json).counter

# WhoAmI requires login (expected 401 before login)
try {
    Invoke-WebRequest -Uri "$base/session/whoami" -WebSession $sess -SkipCertificateCheck -ErrorAction Stop | Out-Null
} catch {
    'status: 401 (unauthorized)'
}

# Login and read identity
Invoke-WebRequest -Uri "$base/session/login?user=max" -WebSession $sess -SkipCertificateCheck | Out-Null
(Invoke-WebRequest -Uri "$base/session/whoami" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json

# Generic set/get within the same session
Invoke-WebRequest -Uri "$base/session/set?key=color&value=purple" -WebSession $sess -SkipCertificateCheck | Out-Null
(Invoke-WebRequest -Uri "$base/session/get?key=color" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json

# Logout clears the session
Invoke-WebRequest -Uri "$base/session/logout" -WebSession $sess -SkipCertificateCheck | Out-Null
try {
    Invoke-WebRequest -Uri "$base/session/whoami" -WebSession $sess -SkipCertificateCheck -ErrorAction Stop | Out-Null
} catch {
    'status: 401 (unauthorized)'
}
```

> Tip: Ensure the SQL cache table is created using the standard schema for Microsoft.Extensions.Caching.SqlServer.

## Key Points

- Use SQL Server for session storage compatible with multi-instance deployments.
- The sample demonstrates `Add-KrDistributedSqlServerCache` plus `Add-KrSession`.
- Cookie settings matter in production: Secure, HttpOnly, SameSite.
- Session must be enabled before routes that depend on it.

## Troubleshooting

- SQL connection errors: Verify credentials and network connectivity.
- Table not found: Ensure the cache table is provisioned; see official docs for schema.
- Session not persisting: Confirm cookie is preserved and DB operations succeed.

## References

- [Add-KrDistributedSqlServerCache][Add-KrDistributedSqlServerCache]
- [Add-KrSession][Add-KrSession]
- [New-KrCookieBuilder][New-KrCookieBuilder]
- [Sessions Guide][Sessions Guide]

---

### Previous / Next

Previous: [Sessions with Redis](./2.Sessions-Redis.md)
Next: [Index](./index.md)

[19.3-Sessions-Sql.ps1]: /pwsh/tutorial/examples/19.3-Sessions-Sql.ps1
[Add-KrDistributedSqlServerCache]: /pwsh/cmdlets/Add-KrDistributedSqlServerCache
[Add-KrSession]: /pwsh/cmdlets/Add-KrSession
[New-KrCookieBuilder]: /pwsh/cmdlets/New-KrCookieBuilder
[Sessions Guide]: /topics/sessions
