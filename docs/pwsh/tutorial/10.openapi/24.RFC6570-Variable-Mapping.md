---
title: RFC 6570 Variable Mapping
parent: OpenApi
nav_order: 24
layout: default
---

# RFC 6570 Variable Mapping

Document OpenAPI 3.2 RFC 6570 path expressions and map ASP.NET Core route values into RFC6570 variables for multi-segment paths.

## Full source

File: [`pwsh/tutorial/examples/10.23-OpenAPI-Path-Template-Mapping.ps1`][10.23-OpenAPI-Path-Template-Mapping.ps1]

```powershell
{% include examples/pwsh/10.23-OpenAPI-Path-Template-Mapping.ps1 %}
```

## Step-by-step

1. **Logging**: Register the console logger as default.
2. **Server**: Create a server and listener (IP + port).
3. **OpenAPI Info + Tags**: Add document metadata and tags (`Users`, `Files`, `API`).
4. **Schema Components**: Define `User`, `FileInfo`, and `VariableMapping` as reusable schema components.
5. **Simple routes**: Define OpenAPI-annotated routes like `/users/{userId}` and `/api/v{version}/users/{userId}`.
6. **Multi-segment paths**: Document the route as `/files/{+path}` (RFC6570 reserved expansion).
Kestrun maps this to the Kestrel catch-all route `/files/{**path}` automatically.
7. **Introspection route**: Return a small JSON payload from `/mapping/{template}/{id}` to demonstrate captured route values.
8. **Build + Run**: Enable configuration, expose OpenAPI routes, build the OpenAPI document, add Swagger/ReDoc routes, and start the server.

## Try it

Start the server:

```powershell
pwsh .\docs\_includes\examples\pwsh\10.23-OpenAPI-Path-Template-Mapping.ps1
```

Call the routes:

```powershell
curl -i http://127.0.0.1:5000/users/42
curl -i http://127.0.0.1:5000/api/v1/users/123
curl -i http://127.0.0.1:5000/files/documents/reports/2024/annual.pdf
curl -i http://127.0.0.1:5000/mapping/mytemplate/999
```

Fetch the OpenAPI 3.2 document and open Swagger:

```powershell
curl http://127.0.0.1:5000/openapi/v3.2/openapi.json
Start-Process http://127.0.0.1:5000/docs/swagger
```

## Key points

- OpenAPI 3.2 uses RFC6570 URI templates for path expressions (e.g. `{+path}` for multi-segment path variables).
- Kestrun maps RFC6570 multi-segment variables to Kestrel catch-all parameters (`{**path}`) at runtime.
- Kestrun bridges the gap by mapping ASP.NET route values into RFC6570 variable assignments.

## Troubleshooting

- **`/files/...` returns 404**: Ensure the OpenAPI template uses RFC6570 multi-segment syntax (e.g. `/files/{+path}` or `/files/{path*}`).
- **OpenAPI does not show `{+path}`**: Ensure the OpenAPI template is documented with RFC6570 syntax (e.g. `Pattern = '/files/{+path}'`).
- **Startup errors**: Ensure `Enable-KrConfiguration` runs after defining routes and OpenAPI metadata, and before `Start-KrServer`.

## References

- [Add-KrOpenApiInfo][Add-KrOpenApiInfo]
- [Add-KrOpenApiTag][Add-KrOpenApiTag]
- [Add-KrOpenApiRoute][Add-KrOpenApiRoute]
- [Build-KrOpenApiDocument][Build-KrOpenApiDocument]
- [Test-KrOpenApiDocument][Test-KrOpenApiDocument]
- [Add-KrApiDocumentationRoute][Add-KrApiDocumentationRoute]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Get-KrRequestRouteParam][Get-KrRequestRouteParam]
- [Write-KrJsonResponse][Write-KrJsonResponse]
- [OpenApiPath][OpenApiPath]
- [OpenApiResponse][OpenApiResponse]
- [OpenAPI Generation Guide][OpenAPI Generation Guide]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [XML Modeling](./23.XML-Modeling)
Next: [Razor](../11.razor/index)

[10.23-OpenAPI-Path-Template-Mapping.ps1]: /pwsh/tutorial/examples/10.23-OpenAPI-Path-Template-Mapping.ps1
[Add-KrOpenApiInfo]: /pwsh/cmdlets/Add-KrOpenApiInfo
[Add-KrOpenApiTag]: /pwsh/cmdlets/Add-KrOpenApiTag
[Add-KrOpenApiRoute]: /pwsh/cmdlets/Add-KrOpenApiRoute
[Build-KrOpenApiDocument]: /pwsh/cmdlets/Build-KrOpenApiDocument
[Test-KrOpenApiDocument]: /pwsh/cmdlets/Test-KrOpenApiDocument
[Add-KrApiDocumentationRoute]: /pwsh/cmdlets/Add-KrApiDocumentationRoute
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Get-KrRequestRouteParam]: /pwsh/cmdlets/Get-KrRequestRouteParam
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
[OpenApiPath]: /pwsh/cmdlets/OpenApiPath
[OpenApiResponse]: /pwsh/cmdlets/OpenApiResponse
[OpenAPI Generation Guide]: /guides/openapi
