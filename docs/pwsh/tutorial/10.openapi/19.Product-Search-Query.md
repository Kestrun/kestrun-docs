---
title: Product Search with HTTP QUERY (OpenAPI 3.2)
layout: default
parent: OpenApi
nav_order: 19
---

# Product Search with HTTP QUERY (OpenAPI 3.2)

Demonstrates the OpenAPI 3.2 HTTP `QUERY` method with structured request body filters, pagination parameters, and response content negotiation.

## Full source

File: [`pwsh/tutorial/examples/10.19-OpenAPI-Hello-Query.ps1`][10.19-OpenAPI-Hello-Query.ps1]

```powershell
{% include examples/pwsh/10.19-OpenAPI-Hello-Query.ps1 %}
```

## Step-by-step

1. **Server setup**: Create the host with [New-KrServer][New-KrServer] and configure an endpoint with [Add-KrEndpoint][Add-KrEndpoint].

2. **OpenAPI metadata + schemas**: Register OpenAPI info with [Add-KrOpenApiInfo][Add-KrOpenApiInfo], then define request/response schemas as PowerShell classes:

    - `Product`: item id, name, price, stock.
    - `ProductSearchRequest`: filters like `q`, `category`, `minPrice`, `maxPrice`, `inStock`.

3. **Reusable pagination parameters**: Define pagination parameter components with `[OpenApiParameterComponent]` (including validation, e.g., `ValidateRange`).

4. **Define the QUERY operation**: Create a route function decorated with
   `[OpenApiPath(HttpVerb = 'query', Pattern = '/v1/products/search')]`.

5. **Wire up inputs**: Reference pagination components via `[OpenApiParameterRef]` and accept the structured filter body via `[OpenApiRequestBody]`
using the `ProductSearchRequest` schema.

6. **Implement filtering + pagination**: Apply text/category/price/stock filters, then compute offset/limit from `page`/`pageSize` and return the appropriate slice.

7. **Return a negotiated response**: Use [Write-KrResponse][Write-KrResponse] (not `Write-KrJsonResponse`) to honor the `Accept` header (JSON, YAML, XML).

8. **Finalize configuration and start**: Register documentation UIs ([Add-KrApiDocumentationRoute][Add-KrApiDocumentationRoute]) and the OpenAPI document route
 ([Add-KrOpenApiRoute][Add-KrOpenApiRoute], `DefaultVersion '3.2'`), commit staged changes with [Enable-KrConfiguration][Enable-KrConfiguration],
 then start the server with [Start-KrServer][Start-KrServer].

## Try it

Save the sample and run:

```powershell
# From repository root
Import-Module .\src\PowerShell\Kestrun\Kestrun.psd1 -Force
.\docs\_includes\examples\pwsh\10.19-OpenAPI-Hello-Query.ps1 -Port 5000
```

Then open [**http://127.0.0.1:5000/docs/swagger**](http://127.0.0.1:5000/docs/swagger) in your browser to
view the interactive API documentation.

### Test the QUERY endpoint

Using curl:

```powershell
curl -X QUERY "http://127.0.0.1:5000/v1/products/search?page=1&pageSize=2" `
  -H "Content-Type: application/json" `
  -H "Accept: application/json" `
  -d "{""q"":""lap"",""category"":""electronics"",""minPrice"":800,""inStock"":true}"
```

Using PowerShell:

```powershell
$body = @{
    q = 'lap'
    category = 'electronics'
    minPrice = 800
    inStock = $true
} | ConvertTo-Json -Depth 5

$result = Invoke-WebRequest -Uri 'http://127.0.0.1:5000/v1/products/search?page=1&pageSize=2' `
    -CustomMethod 'QUERY' `
    -ContentType 'application/json' `
    -Body $body `
    -Headers @{ Accept = 'application/json' } `
    -SkipCertificateCheck

$result.Content | ConvertFrom-Json | Format-Table
```

Stop the server with Ctrl+C.

## Troubleshooting

- **Port already in use**: Choose a different port with `-Port 5001` or similar.
- **QUERY not recognized**: Ensure PowerShell 7.4+ (which supports `-CustomMethod 'QUERY'` in `Invoke-WebRequest`).
- **OpenAPI spec mismatch**: Verify `HttpVerb = 'query'` in the function's `[OpenApiPath]` attribute; OpenAPI 3.2 uses `query` (lowercase) as the operation key.
- **No documentation UIs**: Check that [Add-KrApiDocumentationRoute][Add-KrApiDocumentationRoute] is called _before_ [Enable-KrConfiguration][Enable-KrConfiguration].
- **Negotiated response returns JSON only**: Ensure you use [Write-KrResponse][Write-KrResponse]
    (not `Write-KrJsonResponse`); the latter forces JSON regardless of `Accept` header.

## References

- [New-KrServer][New-KrServer]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Add-KrOpenApiInfo][Add-KrOpenApiInfo]
- [Add-KrApiDocumentationRoute][Add-KrApiDocumentationRoute]
- [Add-KrOpenApiRoute][Add-KrOpenApiRoute]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Write-KrResponse][Write-KrResponse]
- [Start-KrServer][Start-KrServer]
- [OpenAPI-Guide][OpenAPI-Guide]

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Multiple OpenAPI Documents](./18.Multi-Document-OpenAPI)
Next: [SSE](./20.Sse)

[10.19-OpenAPI-Hello-Query.ps1]: /pwsh/tutorial/examples/10.19-OpenAPI-Hello-Query.ps1
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Add-KrOpenApiInfo]: /pwsh/cmdlets/Add-KrOpenApiInfo
[Add-KrApiDocumentationRoute]: /pwsh/cmdlets/Add-KrApiDocumentationRoute
[Add-KrOpenApiRoute]: /pwsh/cmdlets/Add-KrOpenApiRoute
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Write-KrResponse]: /pwsh/cmdlets/Write-KrResponse
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[OpenAPI-Guide]: /guides/openapi
