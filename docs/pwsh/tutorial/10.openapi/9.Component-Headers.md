---
title: Component Headers
parent: OpenApi
nav_order: 9
---

# Component Headers

Demonstrates how to define reusable header components for OpenAPI responses.

Kestrun supports reusable **response header components** by:

1. Defining headers under `components/headers` using `New-KrOpenApiHeader` + `Add-KrOpenApiComponent`
2. Attaching them to responses with `OpenApiResponseHeaderRef` (emits a `$ref` to the header component)
3. Setting the actual HTTP headers at runtime via `$Context.Response.Headers[...]`

## Response headers vs header parameters

OpenAPI has two different (often confused) concepts:

- **Response headers** (this page): documented under `responses[status].headers` and defined under `components.headers`.
- **Header parameters** (request inputs): documented under `parameters` and (optionally) defined under `components.parameters` with `in: header`.

Use **response headers** for things like `Location`, `ETag`, `Retry-After`, `X-Correlation-Id`.
Use **header parameters** for request inputs like `X-Api-Key`.

## Full source

File: [`pwsh/tutorial/examples/10.9-OpenAPI-Component-Header.ps1`][10.9-OpenAPI-Component-Header.ps1]

```powershell
{% include examples/pwsh/10.9-OpenAPI-Component-Header.ps1 %}
```

## Step-by-step

1. Define header components
2. Reference headers from responses
3. Define one-off inline headers
4. Set headers at runtime

### 1) Define header components

Create a reusable header definition and store it under `components/headers`:

```powershell
New-KrOpenApiHeader \
    -Description 'Correlation id for tracing the request across services.' \
    -Schema ([string]) \
    -Required |
    Add-KrOpenApiComponent -Name 'X-Correlation-Id'
```

Repeat for other reusable headers (e.g., `Location`, `ETag`, `Retry-After`, `X-RateLimit-*`).

**Tip:** You can attach examples to a header using the `-Examples` parameter:

```powershell
$etagExamples = @{ weak = New-KrOpenApiExample -Summary 'Weak ETag' -Value 'W/"user-1-v3"' }
New-KrOpenApiHeader -Description 'Entity tag representing the current version of the resource.' -Schema ([string]) -Examples $etagExamples |
    Add-KrOpenApiComponent -Name 'ETag'
```

### 2) Reference headers from responses

Use `OpenApiResponseHeaderRef` on the route function. `Key` is the header name in the response object, and `ReferenceId` is the component name:

```powershell
function createUser {
    [OpenApiPath(HttpVerb = 'post', Pattern = '/users', Tags = 'Users')]
    [OpenApiResponse(StatusCode = '201', Description = 'Created')]
    [OpenApiResponseHeaderRef(StatusCode = '201', Key = 'X-Correlation-Id', ReferenceId = 'X-Correlation-Id')]
    [OpenApiResponseHeaderRef(StatusCode = '201', Key = 'Location', ReferenceId = 'Location')]
    [OpenApiResponseHeaderRef(StatusCode = '201', Key = 'ETag', ReferenceId = 'ETag')]
    param()
}
```

#### Key vs ReferenceId

- `Key` becomes the property name under `responses[status].headers[key]` in the output.
- `ReferenceId` must match the name you used in `Add-KrOpenApiComponent -Name ...`.

If the `ReferenceId` does not exist, the header won’t be emitted (or you’ll see warnings during document generation).

### 3) Define one-off inline headers

For headers you don’t want to reuse, define them inline with `OpenApiResponseHeader`:

```powershell
[OpenApiResponse(StatusCode = '400', Description = 'Invalid input')]
[OpenApiResponseHeader(StatusCode = '400', Key = 'X-Error-Code', Description = 'Machine-readable error code.', Schema = ([string]))]
```

If you have a reusable header component but want to **embed it inline** (no `$ref`), set `Inline = $true` on `OpenApiResponseHeaderRef`.

### 4) Set headers at runtime

OpenAPI documents the header; your route still needs to set the actual response header values:

```powershell
$Context.Response.Headers['X-Correlation-Id'] = [Guid]::NewGuid().ToString()
$Context.Response.Headers['Location'] = "/users/$id"
$Context.Response.Headers['ETag'] = "W/`"user-$id-v1`""
```

## Where to verify in `openapi.json`

After you run the sample, fetch:

- `http://127.0.0.1:5000/openapi/v3.1/openapi.json`

Then inspect these locations:

- `components.headers.ETag`
- `components.headers.X-Correlation-Id`
- `paths['/users'].post.responses['201'].headers.ETag.$ref`
- `paths['/users'].post.responses['400'].headers.X-Error-Code` (inline header)

## What the sample demonstrates

The included sample implements a small `/users` API and documents operational headers:

- `POST /users` returns `201` + `Location`, `ETag`, `X-Correlation-Id`, and demo `X-RateLimit-*` headers
- `GET /users/{userId}` returns `200` + `ETag`, `X-Correlation-Id`, `X-RateLimit-*`
- `POST /users` may return `400` with inline `X-Error-Code`
- Some routes may return `429` with `Retry-After`

## Try it

From the repository root:

```powershell
pwsh .\docs\_includes\examples\pwsh\10.9-OpenAPI-Component-Header.ps1
```

Then open:

- OpenAPI JSON: `http://127.0.0.1:5000/openapi/v3.1/openapi.json`
- Swagger UI: `http://127.0.0.1:5000/docs/swagger`
- Redoc: `http://127.0.0.1:5000/docs/redoc`

## Troubleshooting

**Issue**: Routes return `500` and logs show “The term 'Some-Function' is not recognized”.

- **Cause**: Kestrun captures caller-defined helper functions/variables when `Enable-KrConfiguration` runs.
- **Fix**: Ensure helper functions and shared variables used by routes are defined **before** calling `Enable-KrConfiguration`.

## References

- [OpenAPI Header Object][OpenAPI Header Object]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Document Info](./8.Document-Info.md)
Next: [Component Links](./10.Component-Links.md)

[10.9-OpenAPI-Component-Header.ps1]: https://github.com/Kestrun/Kestrun/blob/main/docs/_includes/examples/pwsh/10.9-OpenAPI-Component-Header.ps1
[OpenAPI Header Object]: https://spec.openapis.org/oas/v3.1.0#header-object
