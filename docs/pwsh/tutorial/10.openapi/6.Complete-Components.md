---
title: Complete Components
parent: OpenApi
nav_order: 6
---

# Complete Components

Combine request body and response components in a complete API with validation and error handling.

## Full source

File: [`pwsh/tutorial/examples/10.6-OpenAPI-Components-RequestBody-Response.ps1`][10.6-OpenAPI-Components-RequestBody-Response.ps1]

```powershell
{% include examples/pwsh/10.6-OpenAPI-Components-RequestBody-Response.ps1 %}
```

## Step-by-step

1. Logging: Register console logger as default.
2. Server: Create server named 'OpenAPI RequestBody & Response Components'.
3. OpenAPI info: Add title, description, and tags.
4. Define `CreateOrderRequest` schema with productId and quantity.
5. Define `OrderResponse` schema with order details and status.
6. Define `ErrorDetail` schema with code, message, field, and details.
7. Create `CreateOrderRequestBody` component from CreateOrderRequest.
8. Create `OrderResponseComponent` wrapping OrderResponse.
9. Create `ErrorResponseComponent` wrapping ErrorDetail.
10. POST endpoint: Accept CreateOrderRequestBody, validate, return OrderResponse or ErrorDetail.
11. GET endpoint: Retrieve order, validate UUID format, return OrderResponse or ErrorDetail.
12. PUT endpoint: Update order using CreateOrderRequestBody, return OrderResponse or ErrorDetail.
13. Build and test OpenAPI document.

## Try it

```powershell
# Create order (POST with CreateOrderRequestBody)
curl -X POST http://127.0.0.1:5000/orders `
  -H "Content-Type: application/json" `
  -d '{
    "productId": 1,
    "quantity": 5,
    "customerEmail": "customer@example.com",
    "shippingAddress": "123 Main St, Anytown"
  }'

# Get order (returns OrderResponse)
curl -i http://127.0.0.1:5000/orders/a54a57ca-36f8-421b-a6b4-2e8f26858a4c

# Get order with invalid ID (returns ErrorDetail)
curl -i http://127.0.0.1:5000/orders/invalid-id

# Update order (PUT with CreateOrderRequestBody)
curl -X PUT http://127.0.0.1:5000/orders/a54a57ca-36f8-421b-a6b4-2e8f26858a4c `
  -H "Content-Type: application/json" `
  -d '{
    "productId": 2,
    "quantity": 10,
    "customerEmail": "customer@example.com"
  }'

# Create order with invalid quantity (returns ErrorDetail)
curl -X POST http://127.0.0.1:5000/orders `
  -H "Content-Type: application/json" `
  -d '{
    "productId": 1,
    "quantity": 0
  }'
```

PowerShell create order:

```powershell
$orderPayload = @{
    productId        = 1
    quantity         = 5
    customerEmail    = 'customer@example.com'
    shippingAddress  = '123 Main St, Anytown'
} | ConvertTo-Json

$response = Invoke-WebRequest -Uri http://127.0.0.1:5000/orders `
    -Method Post `
    -Headers @{ 'Content-Type' = 'application/json' } `
    -Body $orderPayload

$response.Content | ConvertFrom-Json
```

## Complete API Pattern

```text
POST /orders
├─ Request: CreateOrderRequestBody (required)
├─ Response 201: OrderResponseComponent
└─ Response 400: ErrorResponseComponent

GET /orders/{orderId}
├─ Parameter: orderId (path, UUID format)
├─ Response 200: OrderResponseComponent
└─ Response 400: ErrorResponseComponent

PUT /orders/{orderId}
├─ Parameter: orderId (path, UUID format)
├─ Request: CreateOrderRequestBody (required)
├─ Response 200: OrderResponseComponent
└─ Response 400: ErrorResponseComponent
```

## Validation Patterns

```powershell
# Validate required fields
if (-not $body.productId -or -not $body.quantity) {
    $error = @{
        code    = 'MISSING_FIELDS'
        message = 'productId and quantity are required'
        field   = 'productId,quantity'
    }
    Write-KrJsonResponse $error -StatusCode 400
    return
}

# Validate quantity constraint
if ([int]$body.quantity -le 0) {
    $error = @{
        code    = 'INVALID_QUANTITY'
        message = 'Quantity must be greater than zero'
        field   = 'quantity'
        details = "Provided: $($body.quantity)"
    }
    Write-KrJsonResponse $error -StatusCode 400
    return
}

# Validate UUID format
if (-not [System.Guid]::TryParse($orderId, [ref][System.Guid]::Empty)) {
    $error = @{
        code    = 'INVALID_ORDER_ID'
        message = 'Invalid order ID format'
        field   = 'orderId'
        details = 'Order ID must be a valid UUID'
    }
    Write-KrJsonResponse $error -StatusCode 400
    return
}
```

## Key Concepts

- **Integration**: RequestBody and Response components work together for complete endpoint documentation.
- **Error Handling**: Use consistent ErrorDetail schema for all error responses.
- **Validation**: Validate inputs and return appropriate error codes (MISSING_FIELDS, INVALID_QUANTITY, etc.).
- **Status Codes**: Use 201 for creation, 200 for success, 400 for validation errors.
- **Traceability**: Include operation IDs (UUIDs) in responses for tracking.

## Troubleshooting

**Issue**: Components not reused across endpoints.

- **Solution**: Ensure `[OpenApiRequestBodyRef]` and response attributes use the same component class references across all functions.

**Issue**: Validation errors not returning ErrorDetail schema.

- **Solution**: Verify error response uses `Schema = [ErrorDetail]` and Write-KrJsonResponse returns matching structure.

**Issue**: UUID validation failing.

- **Solution**: Use `[System.Guid]::TryParse($id, [ref][System.Guid]::Empty)` to validate UUID format before processing.

## References

- [OpenApiRequestBodyComponent][OpenApiRequestBodyComponent]
- [OpenApiResponseComponent][OpenApiResponseComponent]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Get-KrRequestRouteParam][Get-KrRequestRouteParam]
- [Write-KrJsonResponse][Write-KrJsonResponse]
- [Build-KrOpenApiDocument][Build-KrOpenApiDocument]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Response Components](./5.Response-Components.md)
Next: [Tags and External Docs](./7.Tags-and-Docs.md)

[OpenApiRequestBodyComponent]: /pwsh/cmdlets/OpenApiRequestBodyComponent
[OpenApiResponseComponent]: /pwsh/cmdlets/OpenApiResponseComponent
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Get-KrRequestRouteParam]: /pwsh/cmdlets/Get-KrRequestRouteParam
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
[Build-KrOpenApiDocument]: /pwsh/cmdlets/Build-KrOpenApiDocument
