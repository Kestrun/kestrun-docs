---
title: Basic Tasks
parent: Tasks
nav_order: 1
---

# Basic Tasks

Run ad-hoc scripts as background tasks with status, progress, results, cancellation, and controlled removal.

## Full source

File: [`pwsh/tutorial/examples/20.1-Task.ps1`][20.1-Task.ps1]

```powershell
{% include examples/pwsh/20.1-Task.ps1 %}
```

## Step-by-step

1. Logging: Register a console logger and set level to Debug.
2. Server: Create a Kestrun server named "Tasks Demo Server".
3. Listener: Listen on loopback using a self-signed certificate on the provided port (HTTPS).
4. Tasks: Enable the ad-hoc task feature with `Add-KrTasksService` (injects progress state per task).
5. Configure: Call `Enable-KrConfiguration` to build the app.
6. Routes: Map endpoints to create, start (idempotent), query state + progress, fetch result, cancel, remove (child-safe), and list tasks.
7. Convenience: Add a one-shot route to create+start a PowerShell task.
8. Start: Run the server asynchronously with `Start-KrServer`.

## Try it

```powershell
$base = 'https://127.0.0.1:5000'

# Create a PowerShell task (does not start)
curl -k -s "$base/tasks/create/ps?seconds=2" | jq

# Create a C# task (does not start)
curl -k -s "$base/tasks/create/cs?ms=1500" | jq

# Start a task by id
$id = 'REPLACE_WITH_ID'
curl -k -s "$base/tasks/start?id=$id" | jq

# Check state (includes progress) and result (result only)
curl -k -s "$base/tasks/state?id=$id" | jq
curl -k -s "$base/tasks/result?id=$id" | jq

# Cancel and remove
curl -k -s "$base/tasks/cancel?id=$id" | jq
curl -k -s "$base/tasks/remove?id=$id" | jq

# List all
curl -k -s "$base/tasks/list" | jq
```

PowerShell equivalents:

```powershell
$base = 'https://127.0.0.1:5000'

$ps = Invoke-RestMethod -Uri "$base/tasks/create/ps?seconds=10" -SkipCertificateCheck
$id = $ps.id

Invoke-RestMethod -Uri "$base/tasks/start?id=$id" -SkipCertificateCheck
Invoke-RestMethod -Uri "$base/tasks/state?id=$id" -SkipCertificateCheck
Invoke-RestMethod -Uri "$base/tasks/state?id=$id" -SkipCertificateCheck | Format-List
Invoke-RestMethod -Uri "$base/tasks/result?id=$id" -SkipCertificateCheck   # will be $null until terminal

Invoke-RestMethod -Uri "$base/tasks/list" -SkipCertificateCheck
```

## Key Points

- Multi-language (PowerShell, C#, VB.NET) with unified lifecycle.
- Create and start are separate; second start returns `false` (idempotent).
- `$TaskProgress` / `TaskProgress` provides live percent + status; completion sets 100.
- `/tasks/result` returns only the result object (null until terminal state).
- PowerShell result = pipeline objects; C#/VB result = last expression value.
- Cancellation cooperates across languages (PS `Stop()`, C# token, VB awaited delay).
- Removal only after task and any children are terminal (cascade uses snapshot to avoid collection mutation).

## Troubleshooting

- Task never leaves `NotStarted`: Ensure the runspace pool size is > 0 and the feature `Add-KrTasks` was invoked before `Enable-KrConfiguration`.
- Cancel returns true but state stays `Running`: The script may be ignoring cancellation (e.g., tight CPU loop).
  Add brief sleeps or yield points, and emit progress updates via `$TaskProgress`.
- Result is `$null` after completion: For PowerShell tasks that produce no pipeline output, this is expected. Emit objects or write output to capture a result array.
- Removal returns false: Verify the task is in a terminal state and that any child tasks have also completed or stopped.

## References

- [Add-KrTasksService][Add-KrTasksService]
- [New-KrTask][New-KrTask]
- [Start-KrTask][Start-KrTask]
- [Get-KrTask][Get-KrTask]
- [Stop-KrTask][Stop-KrTask]
- [Remove-KrTask][Remove-KrTask]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Write-KrJsonResponse][Write-KrJsonResponse]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Start-KrServer][Start-KrServer]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [_None_](.)
Next: [Tasks Guide](/guides/tasks)

[20.1-Task.ps1]: /pwsh/tutorial/examples/20.1-Task.ps1
[Add-KrTasksService]: /pwsh/cmdlets/Add-KrTasksService
[New-KrTask]: /pwsh/cmdlets/New-KrTask
[Start-KrTask]: /pwsh/cmdlets/Start-KrTask
[Get-KrTask]: /pwsh/cmdlets/Get-KrTask
[Stop-KrTask]: /pwsh/cmdlets/Stop-KrTask
[Remove-KrTask]: /pwsh/cmdlets/Remove-KrTask
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
