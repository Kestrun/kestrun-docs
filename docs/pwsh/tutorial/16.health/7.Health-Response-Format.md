---
title: Health Response Format
parent: Health
nav_order: 7
---

# Health Response Format

Demonstrates configuring health endpoints with Auto response format for content negotiation
with multiple diverse health probes for comprehensive monitoring.

## Full source

File: [`pwsh/tutorial/examples/16.7-Health-Response-Format.ps1`][16.7-Health-Response-Format.ps1]

```powershell
{% include examples/pwsh/16.7-Health-Response-Format.ps1 %}
```

## Step-by-step

1. Register a health endpoint with `-ResponseContentType Auto` for content negotiation.
2. Add diverse probes (database/cache/disk) with realistic thresholds.
3. Optionally set `-XmlRootElementName` and `-Compress` for XML.
4. Start the server and call the endpoint with different Accept headers.

## Response Formats

### YAML Format

Human-readable format ideal for debugging and configuration review:

```yaml
overallStatus: Healthy
totalDuration: "00:00:00.1234567"
probes:
- name: "Database"
  status: "Healthy"
  description: "Connected in 23ms"
```

### JSON Format

Standard API format for programmatic consumption:

```json
{
  "overallStatus": "Healthy",
  "totalDuration": "00:00:00.1234567",
  "probes": [
    {
      "name": "Database",
      "status": "Healthy",
      "description": "Connected in 23ms"
    }
  ]
}
```

### XML Format

Legacy enterprise integration format:

```xml
<HealthReport>
  <OverallStatus>Healthy</OverallStatus>
  <TotalDuration>00:00:00.1234567</TotalDuration>
  <Probes>
    <ProbeResult>
      <Name>Database</Name>
      <Status>Healthy</Status>
      <Description>Connected in 23ms</Description>
    </ProbeResult>
  </Probes>
</HealthReport>
```

## Probe Examples

This sample includes three diverse probes demonstrating different monitoring scenarios:

### Database Probe

Simulates database connectivity with realistic connection timing:

- **Healthy**: Connection established with timing metrics
- **Data**: Connection time in milliseconds, server endpoint

### Cache Probe

Monitors cache performance with hit ratio tracking:

- **Healthy**: Hit ratio ≥ 80%
- **Degraded**: Hit ratio < 80%
- **Data**: Hit ratio percentage, cache entry count

### Disk Space Probe

Checks available disk space with tiered alerting:

- **Healthy**: Free space ≥ 20%
- **Degraded**: Free space 10-19%
- **Unhealthy**: Free space < 10%
- **Data**: Free percentage, total GB, available GB

## Try It

Start the script, then test the endpoint with different Accept headers:

```powershell
# JSON format (default)
Invoke-RestMethod http://127.0.0.1:5000/healthz | ConvertTo-Json -Depth 4

# YAML format (with Accept header)
Invoke-RestMethod http://127.0.0.1:5000/healthz -Headers @{'Accept' = 'application/yaml'}

# XML format (with Accept header)
Invoke-RestMethod http://127.0.0.1:5000/healthz -Headers @{'Accept' = 'application/xml'}

# Custom XML root + compact output
Add-KrHealthEndpoint -ResponseContentType Xml -XmlRootElementName 'HealthReport' -Compress
Invoke-RestMethod http://127.0.0.1:5000/healthz -Headers @{'Accept' = 'application/xml'}

# Filter by tags
Invoke-RestMethod 'http://127.0.0.1:5000/healthz?tag=core'
Invoke-RestMethod 'http://127.0.0.1:5000/healthz?tag=infra'
```

## Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| Always returns JSON | Missing Accept header | Add `-Headers @{'Accept' = 'application/yaml'}` to request |
| XML not parsing correctly | Client expecting JSON | Ensure Accept header is set to `application/xml` |
| Need custom XML root | Using default root `Response` | Supply `-XmlRootElementName 'MyRoot'` |
| Need smaller payload | Human-readable indentation default | Use `-Compress` |
| Probes missing from output | Tag filtering active | Check query string parameters or adjust DefaultTags |
| Content negotiation not working | Wrong ResponseContentType | Ensure `-ResponseContentType Auto` is used |

[16.7-Health-Response-Format.ps1]: /pwsh/tutorial/examples/16.7-Health-Response-Format.ps1

## References

- [Add-KrHealthEndpoint][Add-KrHealthEndpoint]
- [Add-KrScriptProbe][Add-KrScriptProbe]
- [Add-KrHttpProbe][Add-KrHttpProbe]
- [New-KrProbeResult][New-KrProbeResult]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Disk Probe](./6.Health-Disk-Probe)
Next: [_None_](.)

[Add-KrHealthEndpoint]: /pwsh/cmdlets/Add-KrHealthEndpoint
[Add-KrScriptProbe]: /pwsh/cmdlets/Add-KrScriptProbe
[Add-KrHttpProbe]: /pwsh/cmdlets/Add-KrHttpProbe
[New-KrProbeResult]: /pwsh/cmdlets/New-KrProbeResult
