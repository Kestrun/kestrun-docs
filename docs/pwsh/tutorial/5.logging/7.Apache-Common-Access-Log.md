---
title: Apache Common Access Log
parent: Logging
nav_order: 7
---

# Apache Common Access Log

Add structured request logging in the classic **Apache Common Log Format (CLF)** (also called *Common Access Log*).
This middleware writes a single line per completed HTTP request using the logger you specify.

> Prerequisites: complete earlier logging chapters (Simple Logging → Hot Reload) so you know how to build
> and register loggers. Ensure you have a console or file sink attached to the logger used below so you can
> actually see the emitted lines.

## Full source

File: [`pwsh/tutorial/examples/5.7-ApacheLog.ps1`][5.7-ApacheLog.ps1]

```powershell
{% include examples/pwsh/5.7-ApacheLog.ps1 %}
```

## Step-by-step

1. Logger: create a logger (`myApacheLogger`) with at least a console sink.
2. Server: standard `New-KrServer` (logger doesn’t need to be default—middleware references by name).
3. Listener: add an HTTP endpoint (loopback:5000 by default, overridable with `-Port` / `-IPAddress`).
4. Runtime: `Add-KrPowerShellRuntime` so PowerShell route blocks can execute.
5. Middleware: `Add-KrCommonAccessLogMiddleware -LoggerName 'myApacheLogger' -UseUtcTimestamp` inserts
   the CLF writer into the pipeline (it runs after the response is produced, capturing status & size).
6. Route: simple `/hello` returning text.
7. Start: `Enable-KrConfiguration` finalizes configuration then `Start-KrServer` begins processing.
8. Observe: each request produces one CLF line on the chosen logger.

## Output format

The middleware emits the canonical Common Log Format:

```text
<remote-host> <identd> <user> [<timestamp>] "<method> <path> <protocol>" <status> <bytes>
```

Example:

```text
127.0.0.1 - - [29/Sep/2025:18:42:10 +0000] "GET /hello HTTP/1.1" 200 13
```

Notes:

- `identd` and `user` are `-` (dash) when not available (typical for most modern setups).
- `<bytes>` is the response body length in bytes (or `0` if no body / not measurable).
- When `-UseUtcTimestamp` is supplied, the timestamp is rendered in UTC with `+0000` offset; otherwise local time.
- The logger’s sinks control where the line goes (console, file, etc.).

### Comparison to structured logs

CLF is line-oriented and designed for legacy log analyzers. For richer
analytics (properties, correlation IDs, JSON sinks), use structured
logging covered in earlier chapters. You can run both simultaneously: keep structured logs
for internal analysis and enable CLF solely for interoperability with existing tooling.

## Try it

Run the sample, then issue a few requests:

```powershell
pwsh ./5.7-ApacheLog.ps1
curl http://127.0.0.1:5000/hello
curl http://127.0.0.1:5000/hello
```

Expected console output (lines similar to):

```text
127.0.0.1 - - [29/Sep/2025:18:42:10 +0000] "GET /hello HTTP/1.1" 200 13
127.0.0.1 - - [29/Sep/2025:18:42:12 +0000] "GET /hello HTTP/1.1" 200 13
```

If you direct the logger to a rolling file sink you can tail it:

```powershell
Get-Content .\logs\*apache*.log -Tail 20 -Wait
```

(Adjust to match your configured path/pattern.)

## Customization

Parameter | Effect | Notes
--------- | ------ | -----
`-LoggerName` | Which registered logger to use | Must exist; use `Register-KrLogger` first
`-Logger` | Pass the logger instance directly | Alternative to `-LoggerName`
`-UseUtcTimestamp` | Forces UTC timestamps with +0000 | Omit for local timezone
`-Filter` | (If available in future) limit which requests log | Not yet implemented (roadmap)

Combine with standard logger features:

- Enrichment: add properties (e.g. hostname) – though CLF output itself stays unchanged.
- Multiple sinks: console + file for archival.
- Level override: CLF lines typically use `Information` level; adjust minimum if you previously set higher (e.g. `Warning`).

## Troubleshooting

Symptom | Cause | Fix
------- | ----- | ---
No CLF lines | Wrong logger name | Verify name passed to `Register-KrLogger -Name` matches `-LoggerName`
No output anywhere | Logger lacks console/file sink | Add `Add-KrSinkConsole` or a file sink before registering
Timestamp not UTC | `-UseUtcTimestamp` missing | Add `-UseUtcTimestamp` switch
Bytes always 0 | Response written manually/streamed | Ensure `Write-Kr*Response` helpers or set Content-Length
Duplicate lines | Middleware added twice | Remove duplicate `Add-KrCommonAccessLogMiddleware` calls

## References

- [Add-KrCommonAccessLogMiddleware][Add-KrCommonAccessLogMiddleware]
- [New-KrLogger][New-KrLogger]
- [Register-KrLogger][Register-KrLogger]
- [Add-KrSinkConsole][Add-KrSinkConsole]
- [Write-KrTextResponse][Write-KrTextResponse]
- [New-KrServer][New-KrServer]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Start-KrServer][Start-KrServer]

---

### Next

Previous: [Hot Reload](./6.Hot-Reload)
Guide: [Logging (Concepts)](/guides/logging)

[5.7-ApacheLog.ps1]: /pwsh/tutorial/examples/5.7-ApacheLog.ps1
[Add-KrCommonAccessLogMiddleware]: /pwsh/cmdlets/Add-KrCommonAccessLogMiddleware
[New-KrLogger]: /pwsh/cmdlets/New-KrLogger
[Register-KrLogger]: /pwsh/cmdlets/Register-KrLogger
[Add-KrSinkConsole]: /pwsh/cmdlets/Add-KrSinkConsole
[Write-KrTextResponse]: /pwsh/cmdlets/Write-KrTextResponse
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
