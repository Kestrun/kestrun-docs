---
title: Enrichment & Correlation IDs
parent: Logging
nav_order: 3
---

# Enrichment & Correlation IDs

Attach useful properties (enrichment) to your log events and add a per-request
correlation ID so you can trace a single request across multiple log lines
and even across languages (PowerShell and C# routes).

> See the [Logging guide](/guides/logging) for in-depth enrichment options and Serilog helpers.

## Full source

File: [`pwsh/tutorial/examples/5.3-Enrichment-Correlation-IDs.ps1`][5.3-Enrichment-Correlation-IDs.ps1]

```powershell
{% include examples/pwsh/5.3-Enrichment-Correlation-IDs.ps1 %}
```

## Step-by-step

1. Build a logger with minimum `Debug`, add a global property `App`, enable FromLogContext, and sinks (console + file).
2. Standard server, listener, PowerShell runtime; then apply config with `Enable-KrConfiguration`.
3. PowerShell route `/ps-correlation`:
   - Generate a correlation ID per request (`[guid]::NewGuid().ToString('N')`).
   - Push to LogContext using `Push-KrLogContextProperty -Name CorrelationId -Value $corr` for the scope of the request.
4. C# route `/csharp-correlation`:
   - Use `appLogger.ForContext("CorrelationId", id)` to enrich subsequent events.
5. Start with `Start-KrServer`.

## Try it

Save the sample locally so the log file is easy to find. Copy the contents of
[`pwsh/tutorial/examples/5.3-Enrichment-Correlation-IDs.ps1`][5.3-Enrichment-Correlation-IDs.ps1] into a new file in an
empty working folder (for example, `enrichment.ps1`), then run:

```powershell
# From your working folder
pwsh .\enrichment.ps1
curl http://127.0.0.1:5000/ps-correlation
curl http://127.0.0.1:5000/csharp-correlation
Get-Content .\logs\enrichment.log -Tail 40
```

Expected: Each request shows a unique `CorrelationId` on all events for that request.

Note:

Custom properties like `CorrelationId` and `App` must be referenced in the sink
`OutputTemplate` to be displayed. The example sets console to
`[{App} {Timestamp:HH:mm:ss} {Level:u3} {CorrelationId}] {Message}` and file to
`{Timestamp} [{Level}] ({App}) {CorrelationId} {Message}`.

## Customizing

- Add more properties globally with `Add-KrEnrichProperty` (e.g., `Environment`, `Version`).
- Use Serilog enrichers (machine name, thread id, etc.).
- Consider setting a request header (e.g., `X-Correlation-Id`) and reusing it if present.
- To enable Kestrun framework logs, set your logger as default or pass it via `New-KrServer`.

## Troubleshooting

| Symptom                              | Cause                             | Fix                                             |
|--------------------------------------|-----------------------------------|-------------------------------------------------|
| No CorrelationId appears in events   | Property name mismatch            | Ensure key is exactly `CorrelationId`           |
| Different IDs in one requestâ€™s lines | New GUID generated per log call   | Generate once per request and reuse             |
| No logs written                      | Minimum level too high / bad path | Lower minimum; verify file path and permissions |
| Cannot delete/rename log file        | Logger still open / file handle   | Run `Close-KrLogger`; let the process exit      |

## Cmdlet references

- [New-KrLogger][New-KrLogger]
- [Set-KrLoggerMinimumLevel][Set-KrLoggerMinimumLevel]
- [Add-KrEnrichFromLogContext][Add-KrEnrichFromLogContext]
- [Push-KrLogContextProperty][Push-KrLogContextProperty]
- [Add-KrEnrichProperty][Add-KrEnrichProperty]
- [Add-KrSinkFile][Add-KrSinkFile]
- [Add-KrSinkConsole][Add-KrSinkConsole]
- [Register-KrLogger][Register-KrLogger]
- [Write-KrLog][Write-KrLog]
- [Close-KrLogger][Close-KrLogger]
- [New-KrServer][New-KrServer]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Start-KrServer][Start-KrServer]

---

### Next

{: .fs-4 .fw-500}

Previous: [Multiple Loggers & Levels](./2.Multiple-Loggers-Levels)
Next: [Sinks (Console/File/JSON)](./4.Sinks)
Guide: [Logging (Concepts)](/guides/logging)

[5.3-Enrichment-Correlation-IDs.ps1]: pwsh/tutorial/examples/5.3-Enrichment-Correlation-IDs.ps1
[New-KrLogger]: /pwsh/cmdlets/New-KrLogger
[Set-KrLoggerMinimumLevel]: /pwsh/cmdlets/Set-KrLoggerMinimumLevel
[Add-KrEnrichProperty]: /pwsh/cmdlets/Add-KrEnrichProperty
[Add-KrEnrichFromLogContext]: /pwsh/cmdlets/Add-KrEnrichFromLogContext
[Push-KrLogContextProperty]: /pwsh/cmdlets/Push-KrLogContextProperty
[Add-KrSinkFile]: /pwsh/cmdlets/Add-KrSinkFile
[Add-KrSinkConsole]: /pwsh/cmdlets/Add-KrSinkConsole
[Register-KrLogger]: /pwsh/cmdlets/Register-KrLogger
[Write-KrLog]: /pwsh/cmdlets/Write-KrLog
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Close-KrLogger]: /pwsh/cmdlets/Close-KrLogger
