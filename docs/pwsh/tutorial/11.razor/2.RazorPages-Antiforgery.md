---
title: Razor Pages with Antiforgery
parent: Razor
nav_order: 2
---

# Razor Pages with Antiforgery

Protect unsafe endpoints using cookie + header antiforgery tokens, and expose a token endpoint.

## Full source

File: [`pwsh/tutorial/examples/11.2-RazorPages-Antiforgery.ps1`][11.2-RazorPages-Antiforgery.ps1]

```powershell
{% include examples/pwsh/11.2-RazorPages-Antiforgery.ps1 %}
```

## Step-by-step

1. Root: Call `Initialize-KrRoot` so the sample can use relative paths reliably.
2. Logging: Create a console logger and set it as default.
3. Server: Create a server named `RazorPages` and bind HTTPS with a self-signed certificate.
4. Razor runtime: Enable PowerShell-backed Razor Pages with `Add-KrPowerShellRazorPagesRuntime`.
5. App state: Define `$AppInfo`, `$FeatureFlags`, and `$Motd` to be visible to all pages.
6. Services: Add SignalR hub middleware and the Tasks service.
7. Antiforgery: Add antiforgery middleware, enable the pipeline, then expose `/csrf-token`.
8. Routes: Add unsafe POST routes that require a valid antiforgery token, then start the server.

## Try it

```powershell
# A Razor page (self-signed TLS)
curl -k -i https://127.0.0.1:5000/

# Fetch an antiforgery token (returns JSON) and stores the cookie
curl -k -c cookies.txt https://127.0.0.1:5000/csrf-token

# Copy the token value from the JSON response and use it in the header
curl -k -b cookies.txt -X POST \
  -H "X-CSRF-TOKEN: <paste-token-here>" \
  "https://127.0.0.1:5000/api/operation/start?seconds=3"
```

PowerShell equivalents:

```powershell
# Get token + cookie (use the same WebSession for the follow-up POST)
$tokenResponse = Invoke-RestMethod -Uri https://127.0.0.1:5000/csrf-token -SkipCertificateCheck -SessionVariable s

Invoke-RestMethod -Uri 'https://127.0.0.1:5000/api/operation/start?seconds=3' -Method Post -SkipCertificateCheck \
  -WebSession $s -Headers @{ 'X-CSRF-TOKEN' = $tokenResponse.token }
```

## Antiforgery flow

This sample uses the “SPA-style” preset:

- Cookie name: `.Kestrun.AntiXSRF`
- Header name: `X-CSRF-TOKEN`
- Token route: `/csrf-token` (returns JSON like `{ token, headerName }`)

For unsafe verbs (POST/PUT/PATCH/DELETE), call `/csrf-token` first and then echo the returned token in the configured header while also sending the cookie.

## Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| `/csrf-token` returns 404 | Token route not added | Ensure `Add-KrAntiforgeryTokenRoute` is called before `Start-KrServer` |
| POST returns 400/403 antiforgery error | Missing token header or cookie | Call `/csrf-token` first; send the cookie and `X-CSRF-TOKEN` header on the POST |
| Curl fails with certificate error | Self-signed TLS | Use `curl -k` (demo only) or configure a trusted certificate |
| Antiforgery works in browser but not via curl | Cookies not persisted | Use `curl -c cookies.txt` then `-b cookies.txt` for subsequent requests |

## References

- [Add-KrAntiforgeryMiddleware][Add-KrAntiforgeryMiddleware]
- [Add-KrAntiforgeryTokenRoute][Add-KrAntiforgeryTokenRoute]
- [Antiforgery Guide][Antiforgery Guide]
- [Initialize-KrRoot][Initialize-KrRoot]
- [New-KrLogger][New-KrLogger]
- [Set-KrLoggerLevel][Set-KrLoggerLevel]
- [Add-KrSinkConsole][Add-KrSinkConsole]
- [Register-KrLogger][Register-KrLogger]
- [New-KrServer][New-KrServer]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Add-KrPowerShellRazorPagesRuntime][Add-KrPowerShellRazorPagesRuntime]
- [Add-KrSignalRHubMiddleware][Add-KrSignalRHubMiddleware]
- [Add-KrTasksService][Add-KrTasksService]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Get-KrRequestQuery][Get-KrRequestQuery]
- [New-KrTask][New-KrTask]
- [Send-KrSignalREvent][Send-KrSignalREvent]
- [Stop-KrTask][Stop-KrTask]
- [Write-KrJsonResponse][Write-KrJsonResponse]
- [Start-KrServer][Start-KrServer]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Razor Pages Quickstart](./1.RazorPages-Quickstart)
Next: [Scheduler](../12.scheduling/index)

[11.2-RazorPages-Antiforgery.ps1]: /pwsh/tutorial/examples/11.2-RazorPages-Antiforgery.ps1
[Add-KrAntiforgeryMiddleware]: /pwsh/cmdlets/Add-KrAntiforgeryMiddleware
[Add-KrAntiforgeryTokenRoute]: /pwsh/cmdlets/Add-KrAntiforgeryTokenRoute
[Antiforgery Guide]: /guides/antiforgery
[Initialize-KrRoot]: /pwsh/cmdlets/Initialize-KrRoot
[New-KrLogger]: /pwsh/cmdlets/New-KrLogger
[Set-KrLoggerLevel]: /pwsh/cmdlets/Set-KrLoggerLevel
[Add-KrSinkConsole]: /pwsh/cmdlets/Add-KrSinkConsole
[Register-KrLogger]: /pwsh/cmdlets/Register-KrLogger
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Add-KrPowerShellRazorPagesRuntime]: /pwsh/cmdlets/Add-KrPowerShellRazorPagesRuntime
[Add-KrSignalRHubMiddleware]: /pwsh/cmdlets/Add-KrSignalRHubMiddleware
[Add-KrTasksService]: /pwsh/cmdlets/Add-KrTasksService
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Get-KrRequestQuery]: /pwsh/cmdlets/Get-KrRequestQuery
[New-KrTask]: /pwsh/cmdlets/New-KrTask
[Send-KrSignalREvent]: /pwsh/cmdlets/Send-KrSignalREvent
[Stop-KrTask]: /pwsh/cmdlets/Stop-KrTask
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
