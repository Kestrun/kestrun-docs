---
title: Cancel
parent: Pages
nav_order: 7
---

# Cancel

Run a long operation, stream progress via SignalR, and demonstrate cooperative cancellation guarded by antiforgery.

## Full source

File: [`pwsh/tutorial/examples/Assets/Pages/Cancel.cshtml`][Assets/Pages/Cancel.cshtml]

```razor
{% include examples/pwsh/Assets/Pages/Cancel.cshtml %}
```

File: [`pwsh/tutorial/examples/Assets/Pages/Cancel.cshtml.ps1`][Assets/Pages/Cancel.cshtml.ps1]

```powershell
{% include examples/pwsh/Assets/Pages/Cancel.cshtml.ps1 %}
```

## Step-by-step

1. Feature gate: The page script sets `$Model.HasAntiforgery` based on `$KrServer.AntiforgeryOptions`.
2. Conditional UI: The view shows an “unavailable” message when antiforgery is not enabled.
3. Token bootstrap: The client fetches `/csrf-token` and stores the request token.
4. Start request: The client calls `POST /api/operation/start?seconds=...` with the `X-CSRF-TOKEN` header.
5. Live updates: The client connects to `/hubs/kestrun` and listens for progress/complete events.
6. Cancel: The client calls `POST /tasks/cancel?id=...` with the same CSRF header.

## Try it

This page is designed for browsers (SignalR + JS), but you can still sanity-check the endpoints:

```powershell
# GET the page (requires HTTPS in the antiforgery sample)
curl -k -i https://127.0.0.1:5000/Cancel

# Get token (stores cookie)
curl -k -c cookies.txt https://127.0.0.1:5000/csrf-token

# Start operation (paste token from previous JSON)
curl -k -b cookies.txt -X POST \
  -H "X-CSRF-TOKEN: <paste-token-here>" \
  "https://127.0.0.1:5000/api/operation/start?seconds=3"
```

## Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| Page shows “Cancel demo unavailable” | Antiforgery not enabled | Use the antiforgery server sample (`11.2-RazorPages-Antiforgery.ps1`) |
| SignalR fails to connect | Hub middleware missing | Ensure the server adds the SignalR hub at `/hubs/kestrun` |
| POST returns 400/403 | Missing token header or cookie | Call `/csrf-token` first, then send cookie + `X-CSRF-TOKEN` |

## References

- [Add-KrSignalRHubMiddleware][Add-KrSignalRHubMiddleware]
- [Add-KrAntiforgeryMiddleware][Add-KrAntiforgeryMiddleware]
- [Add-KrAntiforgeryTokenRoute][Add-KrAntiforgeryTokenRoute]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [AppInfo](./6.AppInfo)
Next: [_None_](.)

[Assets/Pages/Cancel.cshtml]: /pwsh/tutorial/examples/Assets/Pages/Cancel.cshtml
[Assets/Pages/Cancel.cshtml.ps1]: /pwsh/tutorial/examples/Assets/Pages/Cancel.cshtml.ps1
[Add-KrSignalRHubMiddleware]: /pwsh/cmdlets/Add-KrSignalRHubMiddleware
[Add-KrAntiforgeryMiddleware]: /pwsh/cmdlets/Add-KrAntiforgeryMiddleware
[Add-KrAntiforgeryTokenRoute]: /pwsh/cmdlets/Add-KrAntiforgeryTokenRoute
