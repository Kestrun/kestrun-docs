---
title: Route Options (MapRouteOptions)
parent: Routes
nav_order: 4
---

# Route Options (MapRouteOptions)

Use `MapRouteOptions` / `New-KrMapRouteOption` to configure routes with richer metadata, different languages, and advanced behaviors.

> Prerequisites: see [Introduction][Introduction].

## Full source

```powershell
{% include examples/pwsh/2.4-Route-Options.ps1 %}
```

## Step-by-step

1. Base setup (module install, server, listener, PowerShell runtime, configuration)
    matches earlier samples.
        It invokes [Add-KrPowerShellRuntime][Add-KrPowerShellRuntime] then
        [Enable-KrConfiguration][Enable-KrConfiguration].
2. XML route (PowerShell script block):
    - Uses `-Pattern` (alias of `-Path`) with a route parameter `{message}`.
    - Reads the parameter via [Get-KrRequestRouteParam][Get-KrRequestRouteParam] -Name message.
    - Responds with [Write-KrXmlResponse][Write-KrXmlResponse].
3. YAML route (hashtable -> [New-KrMapRouteOption][New-KrMapRouteOption]):
    - Demonstrates composing an options object with a property bag.
    - Sets `DisableAntiforgery = $true` (bypasses antiforgery if globally enabled).
    - Pattern is `/yaml`.
    - Because there is no `{message}` segment the route value lookup returns `$null` — change pattern to `/yaml/{message}` if you want a route parameter.
4. JSON route (explicit .NET object):
     - Creates a `[Kestrun.Hosting.Options.MapRouteOptions]` instance for strongly
         typed control.
     - Demonstrates supplying verbs as an enum array (`[Kestrun.Utilities.HttpVerb[]]`).
        - Reads custom data from a header using [Get-KrRequestHeader][Get-KrRequestHeader].
        - Serializes with [Write-KrJsonResponse][Write-KrJsonResponse].
5. Text route (pipeline style + C#):
   - Builds an option with `Language = 'CSharp'` and multiline code (a here‑string) that accesses `Context.Request.Query`.
   - Writes plain text using the synchronous `Context.Response.WriteTextResponse` helper (C# extension method).
6. Mixed construction styles:
    you can mix `-ScriptBlock`, hashtable + [New-KrMapRouteOption][New-KrMapRouteOption],
    manually instantiated `MapRouteOptions`, and C#/VB code.
7. Language selection: Each option sets `Language`; when omitted PowerShell is assumed if you pass a `-ScriptBlock`.
8. Antiforgery: `DisableAntiforgery` shows how to opt out per route if antiforgery is globally active.
9. Retrieving data:
        - Route parameters: [Get-KrRequestRouteParam][Get-KrRequestRouteParam].
        - Headers: [Get-KrRequestHeader][Get-KrRequestHeader].
    - Query string (from C# here): `Context.Request.Query["name"]`.

## When to use MapRouteOptions

Use `MapRouteOptions` when you need more than the simple `-Verbs -Path -ScriptBlock` shape:

- Provide inline code in another language (`Language`, `Code`).
- Configure route-level features like : DisableAntiforgery, CORS, or OpenAPI metadata.
- Programmatically build routes (e.g., in loops) using strongly typed objects.
- Share a common options template and adjust per route.

For quick, minimal routes the simple `Add-KrMapRoute -Verbs Get -Path ... -ScriptBlock {}` form remains fine.

## Try it

Save the sample locally so it’s easy to run. Copy the contents of
[`docs/_includes/examples/pwsh/2.4-Route-Options.ps1`](/_includes/examples/pwsh/2.4-Route-Options.ps1)
into a new file in an empty working folder (for example, `route-options.ps1`), then run:

```powershell
# From your working folder
pwsh .\route-options.ps1
```

Invoke each route:

```powershell
curl http://127.0.0.1:5000/xml/HelloXml
curl http://127.0.0.1:5000/yaml            # will show null message unless you change pattern
curl -H "message: HelloHeader" http://127.0.0.1:5000/json
curl http://127.0.0.1:5000/txt?message=HelloQuery
```

PowerShell equivalents:

```powershell
Invoke-WebRequest -Uri 'http://127.0.0.1:5000/xml/HelloXml' | Select-Object -ExpandProperty Content
Invoke-WebRequest -Uri 'http://127.0.0.1:5000/yaml'         | Select-Object -ExpandProperty Content
Invoke-WebRequest -Uri 'http://127.0.0.1:5000/json' -Headers @{ message = 'HelloHeader' } | Select-Object -ExpandProperty Content
Invoke-WebRequest -Uri 'http://127.0.0.1:5000/txt?message=HelloQuery' | Select-Object -ExpandProperty Content
```

## Cmdlet / API references

- [Add-KrMapRoute][Add-KrMapRoute]
- [New-KrMapRouteOption][New-KrMapRouteOption]
- [Get-KrRequestRouteParam][Get-KrRequestRouteParam]
- [Get-KrRequestHeader][Get-KrRequestHeader]
- [Write-KrXmlResponse][Write-KrXmlResponse]
- [Write-KrYamlResponse][Write-KrYamlResponse]
- [Write-KrJsonResponse][Write-KrJsonResponse]
- [Start-KrServer][Start-KrServer]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Add-KrPowerShellRuntime][Add-KrPowerShellRuntime]

## Troubleshooting

| Symptom                             | Cause                                     | Fix                                                              |
|-------------------------------------|-------------------------------------------|------------------------------------------------------------------|
| `$message` is `$null` on `/yaml`    | Pattern lacks `{message}`                 | Change pattern to `/yaml/{message}` or use query/header instead  |
| Header message not found on `/json` | Missing `message` header                  | Add `-H "message: value"` or use `Get-KrRequestRouteParam`/query |
| C# route errors                     | Typos or missing semicolon in here‑string | Validate C# snippet; keep indentation simple                     |
| 404 Not Found                       | Route not mapped or verb mismatch         | Confirm verb list includes the HTTP method (e.g., GET)           |

---

### Next

{: .fs-4 .fw-500}

Continue to [Route Groups][Next] or explore more advanced patterns with middleware later in the tutorial.

[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[New-KrMapRouteOption]: /pwsh/cmdlets/New-KrMapRouteOption
[Get-KrRequestRouteParam]: /pwsh/cmdlets/Get-KrRequestRouteParam
[Get-KrRequestHeader]: /pwsh/cmdlets/Get-KrRequestHeader
[Write-KrXmlResponse]: /pwsh/cmdlets/Write-KrXmlResponse
[Write-KrYamlResponse]: /pwsh/cmdlets/Write-KrYamlResponse
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Add-KrPowerShellRuntime]: /pwsh/cmdlets/Add-KrPowerShellRuntime
[Next]: ./5.Route-Groups
[Introduction]: ../1.introduction/index#prerequisites
