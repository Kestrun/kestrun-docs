---
layout: default
parent: Middleware
grand_parent: PowerShell Tutorials
title: HTTPS Strict Transport Security (HSTS)
nav_order: 4
---

# HTTPS Strict Transport Security (HSTS)

HTTP Strict Transport Security (HSTS) is a web security policy mechanism that helps protect websites against
protocol downgrade attacks and cookie hijacking. When enabled, HSTS tells browsers to only interact with your
site using secure HTTPS connections, never HTTP.

## Quick Start

Here's a basic example that sets up HTTPS with HSTS:

{% include examples/pwsh/10.4-Https-Hsts.ps1 %}

## Full source

File: [`pwsh/tutorial/examples/10.4-Https-Hsts.ps1`][10.4-Https-Hsts.ps1]

```powershell
{% include examples/pwsh/10.4-Https-Hsts.ps1 %}
```

## Step-by-step

1. **Certificate Creation**: A self-signed certificate is generated for localhost development
2. **Dual Endpoints**: Both HTTP (port 5000) and HTTPS (port 5443) listeners are configured
3. **HSTS Configuration**: The `Add-KrHsts` cmdlet enables HSTS with a 30-day policy, subdomain inclusion, and preload directive
4. **HTTPS Redirection**: HTTP requests are automatically redirected to HTTPS with a 301 permanent redirect
5. **Route Registration**: A simple test route is added to verify the security setup
6. **Browser Enforcement**: After the first HTTPS visit, browsers automatically upgrade HTTP requests to HTTPS

## Understanding HSTS

HSTS works by sending a special header (`Strict-Transport-Security`) that instructs browsers to:

- Only access the site over HTTPS for a specified period
- Automatically upgrade HTTP requests to HTTPS
- Refuse connections if the certificate is invalid

### Key Components

1. **Max Age**: How long browsers should remember the HSTS policy
2. **Include Subdomains**: Whether the policy applies to all subdomains
3. **Preload**: Whether the site should be included in browser preload lists

## Configuration Options

### Basic HSTS Setup

```powershell
# Default 30-day policy
Add-KrHsts

# Custom duration
Add-KrHsts -MaxAgeDays 365
```

### Advanced Configuration

```powershell
# Full HSTS configuration with all options
Add-KrHsts -MaxAgeDays 365 -IncludeSubDomains -Preload -ExcludedHosts @('dev.example.com', 'staging.example.com')
```

### Development and Testing

```powershell
# Enable HSTS in development environments
Add-KrHsts -MaxAgeDays 30 -IncludeSubDomains -Preload -AllowInDevelopment
```

> **Note**: By default, ASP.NET Core excludes localhost and development hosts from HSTS for security. Use `-AllowInDevelopment` to enable HSTS for testing scenarios.

### Using HstsOptions Object

```powershell
# Create custom options object
$hstsOptions = [Microsoft.AspNetCore.HttpsPolicy.HstsOptions]::new()
$hstsOptions.MaxAge = [TimeSpan]::FromDays(90)
$hstsOptions.IncludeSubDomains = $true
$hstsOptions.Preload = $true

Add-KrHsts -Options $hstsOptions
```

## Combining with HTTPS Redirection

HSTS works best when combined with HTTPS redirection:

```powershell
# Set up both HTTPS and HTTP endpoints
Add-KrEndpoint -Port 80 -IPAddress $IPAddress
Add-KrEndpoint -Port 443 -IPAddress $IPAddress -X509Certificate $cert

# Add HTTPS redirection first
Add-KrHttpsRedirection -RedirectStatusCode 301 -HttpsPort 443

# Then add HSTS
Add-KrHsts -MaxAgeDays 365 -IncludeSubDomains -Preload
```

## Security Considerations

### Preload List

The preload directive tells browsers to include your site in their built-in HSTS preload list:

```powershell
Add-KrHsts -MaxAgeDays 365 -IncludeSubDomains -Preload
```

**Important**: Once preloaded, removal from browser lists can be slow and difficult.

### Excluded Hosts

You can exclude specific hosts from HSTS (useful for development):

```powershell
Add-KrHsts -MaxAgeDays 365 -ExcludedHosts @('localhost', '127.0.0.1', 'dev.mysite.com')
```

### Certificate Requirements

HSTS requires valid SSL certificates. Use self-signed certificates only for development:

```powershell
# Development certificate
$cert = New-KrSelfSignedCertificate -DnsNames localhost, 127.0.0.1 -ValidDays 30

# Production should use CA-issued certificates
$cert = Get-ChildItem Cert:\LocalMachine\My | Where-Object Subject -Like "*mysite.com*"
```

## Try It

1. **Run the sample**:

   ```powershell
   .\10.4-Https-Hsts.ps1 -Port 8080
   ```

2. **Test HTTP to HTTPS redirect**:
   - Visit `http://localhost:8080`
   - Notice the redirect to `https://localhost:8523`

3. **Verify HSTS header**:

   ```powershell
   $response = Invoke-WebRequest -Uri "https://localhost:8523" -SkipCertificateCheck
   $response.Headers['Strict-Transport-Security']
   ```

4. **Check browser behavior**:
   - After first HTTPS visit, try typing `http://localhost:8523` in browser
   - Browser should automatically use HTTPS

## Common Patterns

### Development Environment

```powershell
# HSTS enabled for development testing
Add-KrHsts -MaxAgeDays 1 -IncludeSubDomains -AllowInDevelopment
Add-KrHttpsRedirection -RedirectStatusCode 307  # Temporary redirect
```

Alternatively, exclude specific development hosts:

```powershell
# Exclude only specific development hosts
Add-KrHsts -MaxAgeDays 1 -ExcludedHosts @('dev.example.com', 'staging.example.com')
Add-KrHttpsRedirection -RedirectStatusCode 307
```

### Production Environment

```powershell
# Strict HSTS for production
Add-KrHsts -MaxAgeDays 365 -IncludeSubDomains -Preload
Add-KrHttpsRedirection -RedirectStatusCode 301  # Permanent redirect
```

### API Endpoints

```powershell
# HSTS for API with longer duration
Add-KrHsts -MaxAgeDays 730  # 2 years
Add-KrHttpsRedirection -RedirectStatusCode 301
```

## Troubleshooting

**HSTS not working in browser**:

- Clear browser cache and cookies for the site
- Check that HTTPS endpoint is accessible
- Verify certificate is valid

**Development issues with HSTS**:

- Use shorter MaxAge periods during development
- Add development domains to ExcludedHosts
- Use temporary redirects (307) instead of permanent (301)

**Certificate warnings**:

- Self-signed certificates will show warnings
- Use `-SkipCertificateCheck` for testing only
- Consider using `mkcert` for development certificates

### Previous / Next

{: .fs-4 .fw-500}

- [Previous: HTTPS Redirection][https-redirection]
- [Next: CORS][cors]

## References

- [Add-KrHsts][Add-KrHsts]
- [Add-KrHttpsRedirection][Add-KrHttpsRedirection]
- [New-KrSelfSignedCertificate][New-KrSelfSignedCertificate]
- [Add-KrEndpoint][Add-KrEndpoint]
- [HSTS Guide][HSTS Guide]

[https-redirection]: 3.Https-Redirection.md
[cors]: 5.Cors.md
[Add-KrHsts]: /pwsh/cmdlets/Add-KrHsts
[Add-KrHttpsRedirection]: /pwsh/cmdlets/Add-KrHttpsRedirection
[New-KrSelfSignedCertificate]: /pwsh/cmdlets/New-KrSelfSignedCertificate
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[HSTS Guide]: /guides/hsts
[10.4-Https-Hsts.ps1]: /pwsh/tutorial/examples/10.4-Https-Hsts.ps1
