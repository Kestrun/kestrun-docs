---
title: Host Filtering
parent: Middleware
nav_order: 6
---

# Host Filtering

Restrict which Host headers are allowed to reach your app. This mitigates HTTP Host header attacks and ensures requests are routed only for expected hostnames.

## Full source

File: [`pwsh/tutorial/examples/10.6-HostFiltering.ps1`][10.6-HostFiltering.ps1]

```powershell
{% include examples/pwsh/10.6-HostFiltering.ps1 %}
```

## Step-by-step

1. Add the Host Filtering middleware with your allowlist.
2. Commit configuration with `Enable-KrConfiguration`.
3. Map routes as usual; unauthorized hosts never reach them.
4. Start the server and probe with different Host headers.

## Try it

Run the sample:

```powershell
pwsh ./docs/_includes/examples/pwsh/10.6-HostFiltering.ps1
```

Then test allowed vs. blocked hosts:

```bash
# Allowed
curl -i -H "Host: example.com" http://127.0.0.1:5000/hello
curl -i -H "Host: www.example.com" http://127.0.0.1:5000/hello

# Blocked
curl -i -H "Host: blocked.example" http://127.0.0.1:5000/hello

# Empty Host (rejected when -NotAllowEmptyHosts used)
curl -i -H "Host: " http://127.0.0.1:5000/hello
```

```powershell
# Allowed
Invoke-WebRequest http://127.0.0.1:5000/hello -Headers @{ Host = 'example.com' }
Invoke-WebRequest http://127.0.0.1:5000/hello -Headers @{ Host = 'www.example.com' }

# Blocked
Invoke-WebRequest http://127.0.0.1:5000/hello -Headers @{ Host = 'blocked.example' } -SkipHttpErrorCheck

# Empty Host (rejected when -NotAllowEmptyHosts used)
Invoke-WebRequest http://127.0.0.1:5000/hello -Headers @{ Host = '' } -SkipHttpErrorCheck
```

Expected outcomes:

- Allowed hosts → 200 OK with response body.
- Disallowed or empty host → 400 Bad Request. If `-ExcludeFailureMessage` is used, the response body won't include details.

## Key Points

The middleware validates the request Host header against an allowlist and returns 400 Bad Request for non-matching hosts.
You can optionally allow empty Host headers and include a failure message.

| Option | Meaning |
|--------|---------|
| AllowedHosts | List of hostnames to allow (no ports). Supports wildcard `*` for any non-empty, and subdomain wildcards like `*.example.com`. |
| NotAllowEmptyHosts | If set, requests with an empty Host header are rejected. |
| ExcludeFailureMessage | If set, the 400 response omits the failure message body. |

> IPv6 literals must be bracketed and normalized; Unicode hosts are matched using their punycode representation.

## Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| Still seeing 200 for blocked host | Middleware added after configuration or not applied | Ensure `Add-KrHostFiltering` is called before `Enable-KrConfiguration`. |
| Allowed host with port is blocked | Ports are not permitted in `AllowedHosts` | Remove the port; use just the hostname. |
| Wildcard not matching parent domain | `*.example.com` matches subdomains, not the bare `example.com` | Add both `example.com` and `*.example.com` if needed. |

## References

- [Add-KrHostFiltering][Add-KrHostFiltering]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Start-KrServer][Start-KrServer]
- [Write-KrTextResponse][Write-KrTextResponse]
- [Write-KrLog][Write-KrLog]
- [New-KrLogger][New-KrLogger]
- [Set-KrLoggerLevel][Set-KrLoggerLevel]
- [Add-KrSinkConsole][Add-KrSinkConsole]
- [Register-KrLogger][Register-KrLogger]
- [RoutingTopic][RoutingTopic]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [SignalR](./5.SignalR.md)
Next: _None_

[10.6-HostFiltering.ps1]: /pwsh/tutorial/examples/10.6-HostFiltering.ps1
[Add-KrHostFiltering]: /pwsh/cmdlets/Add-KrHostFiltering
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Write-KrTextResponse]: /pwsh/cmdlets/Write-KrTextResponse
[Write-KrLog]: /pwsh/cmdlets/Write-KrLog
[New-KrLogger]: /pwsh/cmdlets/New-KrLogger
[Set-KrLoggerLevel]: /pwsh/cmdlets/Set-KrLoggerLevel
[Add-KrSinkConsole]: /pwsh/cmdlets/Add-KrSinkConsole
[Register-KrLogger]: /pwsh/cmdlets/Register-KrLogger
[RoutingTopic]: /guides/routing
