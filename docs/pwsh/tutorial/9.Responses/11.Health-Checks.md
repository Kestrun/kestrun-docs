---
title: Health Checks
parent: Responses
nav_order: 11
---

# Health Check Endpoint & Probes

Expose `/healthz` alongside your application routes and aggregate multiple probe types (inline script,
HTTP, process). PowerShell wrappers mirror the new host extensions so you can stand up end-to-end
liveness diagnostics without dropping to C#.

## Full source

File: [`pwsh/tutorial/examples/9.11-Health-Checks.ps1`][9.11-Health-Checks.ps1]

```powershell
{% include examples/pwsh/9.11-Health-Checks.ps1 %}
```

## Step-by-step

1. **Server & listener** – create a host named `Health Demo` and bind to `127.0.0.1:5000`.
2. **Runtime** – add the PowerShell runtime so script block routes & probes can execute.
3. **Local heartbeat** – `/ping` returns the standard health payload the HTTP probe will reuse.
4. **Health endpoint** – `Add-KrHealthEndpoint` registers `/healthz`, tightens probe timeout to 5 seconds,
   applies a default `self` tag, and fails the request when any probe is degraded.
5. **Script probe** – `Add-KrHealthProbe` adds an inline PowerShell probe returning `Healthy`.
6. **HTTP probe** – `Add-KrHealthHttpProbe` reuses the route from step 3; tags it `remote` & `self`.
7. **Start** – `Start-KrServer` launches the app so you can query the aggregate result.

## Call the endpoint

```powershell
Invoke-RestMethod -Uri http://127.0.0.1:5000/healthz | Format-List
```

Example response:

```text
status      : Healthy
checks      : {@{name=Self; status=Healthy; duration=00:00:00.0001234}, @{name=Ping; status=Healthy; ...}}
duration    : 00:00:00.0123456
tagsApplied : {self}
```

Probe timeouts/parallelism come from `Add-KrHealthEndpoint` options. Use `-MaxDegreeOfParallelism` if
you register many probes.

## Filter by tag

Request query parameters map to probe tags:

| Example | Result |
|---------|--------|
| `/healthz?tag=self` | Only runs probes tagged `self`. |
| `/healthz?tags=remote,api` | Comma-separated multi-tag filter. |
| `/healthz` | Uses `-DefaultTags` when none provided. |

Tags are case-insensitive. If the filter yields no probes the endpoint returns `Healthy` with an empty list.

## Error handling

- Any probe throwing an exception is marked `Unhealthy` and the exception message is surfaced in the `description` field.
- `-TreatDegradedAsUnhealthy $true` maps degraded probes to HTTP `503`; otherwise degraded reports keep the HTTP status at `200`.
- `-ProbeTimeout` guards against slow probes; exceeding the timeout marks the probe as `Unhealthy` with a timeout description.

## Validation checklist

- `Test-KrRoute -Path '/healthz' -Verb GET` confirms the endpoint was registered.
- `Test-KrRoute -Path '/ping' -Verb GET` ensures the HTTP probe target is reachable.
- Review the server log: `Health probe '{0}' registered.` messages confirm each probe succeeded.

## Try it

```powershell
# Aggregate
Invoke-RestMethod http://127.0.0.1:5000/healthz | ConvertTo-Json -Depth 4

# Force tag filter
Invoke-RestMethod 'http://127.0.0.1:5000/healthz?tag=remote' | ConvertTo-Json -Depth 4

# Simulate downstream failure (stop server or change /ping)
Invoke-RestMethod http://127.0.0.1:5000/healthz -SkipHttpErrorCheck
```

## References

- [`Add-KrHealthEndpoint`](/pwsh/cmdlets/Add-KrHealthEndpoint) *(new)*
- [`Add-KrHealthProbe`](/pwsh/cmdlets/Add-KrHealthProbe) *(new)*
- [`Add-KrHealthHttpProbe`](/pwsh/cmdlets/Add-KrHealthHttpProbe) *(new)*
- [`Add-KrHealthProcessProbe`](/pwsh/cmdlets/Add-KrHealthProcessProbe)
- [Health topic guide](/topics/health)

---

### Next

Explore end-to-end behaviour and advanced strategies in the [Health topic guide](/topics/health).

[9.11-Health-Checks.ps1]: /pwsh/tutorial/examples/9.11-Health-Checks.ps1
