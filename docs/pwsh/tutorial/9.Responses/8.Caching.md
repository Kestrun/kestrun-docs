---
title: Caching & Revalidation
parent: Responses
nav_order: 8
---

# Caching & Revalidation

Combine `Add-KrCacheResponse` (Cache-Control directives) with `Test-KrCacheRevalidation` (ETag / Last-Modified) for efficient conditional requests.

## Full source

File: [`pwsh/tutorial/examples/9.8-Caching.ps1`][9.8-Caching.ps1]

```powershell
{% include examples/pwsh/9.8-Caching.ps1 %}
```

## Step-by-step

1. Logging: Register console logger as default.
2. Server: Create server named 'Responses 9.8'.
3. Listener: Listen on 127.0.0.1:5000.
4. Runtime: Add PowerShell runtime.
5. `/cache-public`: adds Cache-Control public max-age=300.
6. `/cache-private`: adds private, no-store.
7. `/etag`: auto ETag from payload, returns 304 on match.
8. `/versioned`: fixed ETag and Last-Modified.
9. Enable configuration and start server.

## Try it

```powershell
curl -i http://127.0.0.1:5000/cache-public
curl -i http://127.0.0.1:5000/cache-private

# ETag negotiation (first fetch then conditional):
FIRST=$(curl -i http://127.0.0.1:5000/etag 2>$null | tee etag1.txt)
ETAG=$(Select-String -Path etag1.txt -Pattern 'ETag' | ForEach-Object { ($_ -split ':')[1].Trim() })
curl -i -H "If-None-Match: $ETAG" http://127.0.0.1:5000/etag

curl -i http://127.0.0.1:5000/versioned
```

PowerShell equivalents:

```powershell
# Basic cached resource
$first = Invoke-WebRequest -Uri http://127.0.0.1:5000/cache -Headers @{ 'Cache-Control' = 'max-age=0' }
$first.Headers | Format-List Cache-Control, ETag, 'Last-Modified'
$etag = $first.Headers.ETag

# Second request should be 304 (use -SkipHttpErrorCheck to inspect)
$second = Invoke-WebRequest -Uri http://127.0.0.1:5000/cache -Headers @{ 'If-None-Match' = $etag } -SkipHttpErrorCheck:$true
$second.StatusCode

# Revalidation endpoint
$r1 = Invoke-WebRequest -Uri http://127.0.0.1:5000/revalidate
$etag2 = $r1.Headers.ETag
Start-Sleep -Seconds 1
$r2 = Invoke-WebRequest -Uri http://127.0.0.1:5000/revalidate -Headers @{ 'If-None-Match' = $etag2 } -SkipHttpErrorCheck:$true
$r2.StatusCode

# Force different tag example
Invoke-WebRequest -Uri http://127.0.0.1:5000/revalidate -Headers @{ 'If-None-Match' = '"abc123"' } -SkipHttpErrorCheck:$true | Select -Expand RawContent
```

## Example routes

```powershell
# Logging
New-KrLogger | Add-KrSinkConsole | Register-KrLogger -Name 'console' -SetAsDefault

# Server
New-KrServer -Name 'Responses 9.8'

# Listener
Add-KrListener -IPAddress '127.0.0.1' -Port 5000

# Runtime
Add-KrPowerShellRuntime

# Enable configuration
Enable-KrConfiguration

# Public cached route
Add-KrMapRoute -Pattern '/cache-public' -Verbs GET -ScriptBlock {
    Add-KrCacheResponse -Public -MaxAge 300
    Write-KrTextResponse 'cached for 5m'
}

# Private no-store route
Add-KrMapRoute -Pattern '/cache-private' -Verbs GET -ScriptBlock {
    Add-KrCacheResponse -Private -NoStore
    Write-KrTextResponse 'no-store'
}

# ETag negotiation route
Add-KrMapRoute -Pattern '/etag' -Verbs GET -ScriptBlock {
    $payload = (Get-Date).ToUniversalTime().ToString('O')
    if (-not (Test-KrCacheRevalidation -Payload $payload)) {
        Write-KrTextResponse $payload
    }
}

# Explicit versioned resource route
Add-KrMapRoute -Pattern '/versioned' -Verbs GET -ScriptBlock {
    if (-not (Test-KrCacheRevalidation -ETag 'v1' -LastModified (Get-Date '2024-01-01'))) {
        Write-KrTextResponse 'v1 payload'
    }
}

# Start the server
Start-KrServer
```

### References

- [Add-KrCacheResponse](/pwsh/cmdlets/Add-KrCacheResponse)
- [Test-KrCacheRevalidation](/pwsh/cmdlets/Test-KrCacheRevalidation)

---

### Previous / Next

Previous: [Errors](./7.Errors)
Next: [Low-Level Response Stream](./9.Low-Level-Response)

[9.8-Caching.ps1]: /pwsh/tutorial/examples/9.8-Caching.ps1
