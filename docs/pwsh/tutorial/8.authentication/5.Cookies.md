---
title: Cookies
parent: Authentication
nav_order: 5
---

# Cookies

Maintain user sessions with a login form + cookie session authentication.

## Full source

File: [`pwsh/tutorial/examples/8.5-Cookies.ps1`][8.5-Cookies.ps1]

```powershell
{% include examples/pwsh/8.5-Cookies.ps1 %}
```

## Step-by-step

1. Logger: Build and register a console logger at Debug (sets as default so framework/server logs are visible).
2. Server: Create a named server ("Auth Cookies").
3. Listener: Add HTTPS loopback listener on 5000 with a self-signed certificate (`-SelfSignedCert`).
4. Runtime: Add PowerShell runtime so your script routes can execute.
5. Cookie builder: Configure cookie flags via `New-KrCookieBuilder` (`-HttpOnly`, `-SecurePolicy Always`, `-SameSite Strict`).
6. Auth scheme: Pipe builder into `Add-KrCookiesAuthentication` giving scheme name, login/logout/denied paths, sliding expiration & 30‑minute lifespan.
7. Enable: Call `Enable-KrConfiguration` to finalize the server pipeline.
8. Login form (GET): Serve an HTML form at `/cookies/login`.
9. Login (POST): Validate credentials, sign in with `Invoke-KrCookieSignIn` (returns principal when `-PassThru`), write audit log, respond JSON.
10. Protected group: Use `Add-KrRouteGroup -AuthorizationSchema 'Cookies'` to secure `/cookies/logout` and `/cookies/hello`.
11. Start: Run the server with `Start-KrServer`.

### Sign-in mechanics

`Invoke-KrCookieSignIn` issues the auth cookie under the configured scheme.
When using `-PassThru` you receive the principal (claims identity) allowing you
to enrich logs or respond with user info.

### Sliding expiration

The `-SlidingExpiration` flag renews the cookie lifetime on active use (bounded
by any absolute expiry you set). Here `-ExpireTimeSpan (New-TimeSpan -Minutes 30)`
establishes a 30‑minute idle timeout.

### Route group enforcement

Any route inside the group inherits the authorization scheme. Unauthenticated
requests get redirected (for login path) or a 401/403 depending on the scheme’s
configuration.

## Try it

```powershell
# 1) Fetch login form (optional)
Invoke-WebRequest -Uri https://127.0.0.1:5000/cookies/login -SkipCertificateCheck | Select -Expand RawContent | Select-String 'Login'

# 2) Post credentials (stores session in variable)
Invoke-WebRequest -Uri https://127.0.0.1:5000/cookies/login -Method Post -SkipCertificateCheck -Body @{username='admin';password='secret'} -SessionVariable authSession

# (Optional) Inspect cookie
$authSession.Cookies | Format-Table -Auto

# 3) Access protected route
Invoke-WebRequest -Uri https://127.0.0.1:5000/cookies/hello -SkipCertificateCheck -WebSession $authSession | Select -Expand Content

# 4) Logout
Invoke-WebRequest -Uri https://127.0.0.1:5000/cookies/logout -SkipCertificateCheck -WebSession $authSession | Select -Expand RawContent
```

## References

- [Register-KrLogger][Register-KrLogger]
- [Write-KrLog][Write-KrLog]
- [New-KrCookieBuilder][New-KrCookieBuilder]
- [Add-KrCookiesAuthentication][Add-KrCookiesAuthentication]
- [Invoke-KrCookieSignIn][Invoke-KrCookieSignIn]
- [Invoke-KrCookieSignOut][Invoke-KrCookieSignOut]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Add-KrRouteGroup][Add-KrRouteGroup]
- [New-KrServer][New-KrServer]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Start-KrServer][Start-KrServer]
- [Set-KrLoggerLevel][Set-KrLoggerLevel]
- [Add-KrSinkConsole][Add-KrSinkConsole]

## Troubleshooting

| Symptom            | Cause                   | Fix                                |
| ------------------ | ----------------------- | ---------------------------------- |
| 401 after login    | Session not stored      | Reuse same WebRequestSession       |
| Cookie missing     | Secure / HTTPS mismatch | Use HTTPS or adjust `SecurePolicy` |
| Logout not working | Using new session       | Reuse session for logout route     |
| Login always fails | Credential check logic  | Inspect form parsing               |

## Security notes

- Demo credentials (`admin` / `secret`) are hard-coded for illustration — use a proper user store & password hashing (e.g., PBKDF2, bcrypt, Argon2).
- Always deploy behind TLS; secure cookies (`-SecurePolicy Always`) should not be downgraded in production.
- Consider `SameSite=Lax` if third-party login flows or cross-site POST callbacks are required.
- Audit events: treat `Write-KrLog` entries at sign-in/sign-out as security logs; restrict file and console exposure as appropriate.
- Avoid leaking sensitive claims to the client; only return minimal JSON.

---

### Previous / Next

{: .fs-4 .fw-500}

- Previous: [JWT Tokens][Prev]
- Next: [Windows Authentication][Next]

[8.5-Cookies.ps1]: /pwsh/tutorial/examples/8.5-Cookies.ps1
[Add-KrCookiesAuthentication]: /pwsh/cmdlets/Add-KrCookiesAuthentication
[Register-KrLogger]: /pwsh/cmdlets/Register-KrLogger
[Write-KrLog]: /pwsh/cmdlets/Write-KrLog
[New-KrCookieBuilder]: /pwsh/cmdlets/New-KrCookieBuilder
[Invoke-KrCookieSignIn]: /pwsh/cmdlets/Invoke-KrCookieSignIn
[Invoke-KrCookieSignOut]: /pwsh/cmdlets/Invoke-KrCookieSignOut
[Set-KrLoggerLevel]: /pwsh/cmdlets/Set-KrLoggerLevel
[Add-KrSinkConsole]: /pwsh/cmdlets/Add-KrSinkConsole
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Add-KrRouteGroup]: /pwsh/cmdlets/Add-KrRouteGroup
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Prev]: ./4.Jwt
[Next]: ./6.Windows-Authentication
