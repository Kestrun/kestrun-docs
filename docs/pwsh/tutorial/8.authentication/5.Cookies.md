---
title: Cookies
parent: Authentication
nav_order: 5
---

# Cookies Authentication

Maintain user sessions with a login form + cookie session authentication (now using self-signed HTTPS listener).

## Full source

File: [`pwsh/tutorial/examples/8.5-Cookies.ps1`][8.5-Cookies.ps1]

```powershell
{% include examples/pwsh/8.5-Cookies.ps1 %}
```

## Step-by-step

1. Create logger (set minimum level Debug) & server.
2. Add HTTPS listener with `-SelfSignedCert` (loopback 5000).
3. Add PowerShell runtime.
4. Build cookie builder (name, HttpOnly, secure policy setting).
5. Register cookie auth scheme with login, logout, denied paths.
6. Enable configuration.
7. Map GET `/cookies/login` (HTML form) route.
8. Map POST `/cookies/login` (issues cookie after validating credentials) route.
9. Map protected group `/cookies` with `/logout` and `/hello` secured routes.
10. Start server.

## Try it

```powershell
# 1) Fetch login form (optional)
Invoke-WebRequest -Uri https://127.0.0.1:5000/cookies/login -SkipCertificateCheck | Select -Expand RawContent | Select-String 'Login'

# 2) Post credentials (stores session in variable)
Invoke-WebRequest -Uri https://127.0.0.1:5000/cookies/login -Method Post -SkipCertificateCheck -Body @{username='admin';password='secret'} -SessionVariable authSession

# 3) Access protected route
Invoke-WebRequest -Uri https://127.0.0.1:5000/cookies/hello -SkipCertificateCheck -WebSession $authSession | Select -Expand Content

# 4) Logout
Invoke-WebRequest -Uri https://127.0.0.1:5000/cookies/logout -SkipCertificateCheck -WebSession $authSession | Select -Expand RawContent
```

## Cmdlet references

- [Add-KrCookiesAuthentication][Add-KrCookiesAuthentication]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Add-KrRouteGroup][Add-KrRouteGroup]
- [New-KrServer][New-KrServer]
- [Add-KrListener][Add-KrListener]
- [Add-KrPowerShellRuntime][Add-KrPowerShellRuntime]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Start-KrServer][Start-KrServer]

## Troubleshooting

| Symptom            | Cause                   | Fix                                |
| ------------------ | ----------------------- | ---------------------------------- |
| 401 after login    | Session not stored      | Reuse same WebRequestSession       |
| Cookie missing     | Secure / HTTPS mismatch | Use HTTPS or adjust `SecurePolicy` |
| Logout not working | Using new session       | Reuse session for logout route     |
| Login always fails | Credential check logic  | Inspect form parsing               |

---

### Next

Continue to [Claims & Policies](./6.Claims-Policies).

[8.5-Cookies.ps1]: /pwsh/tutorial/examples/8.5-Cookies.ps1
[Add-KrCookiesAuthentication]: /pwsh/cmdlets/Add-KrCookiesAuthentication
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Add-KrRouteGroup]: /pwsh/cmdlets/Add-KrRouteGroup
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrListener]: /pwsh/cmdlets/Add-KrListener
[Add-KrPowerShellRuntime]: /pwsh/cmdlets/Add-KrPowerShellRuntime
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
