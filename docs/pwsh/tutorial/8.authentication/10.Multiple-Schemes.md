---
title: Multiple Schemes
parent: Authentication
nav_order: 10
---

# Multiple Schemes

Combine several authentication mechanisms (Basic, API Key, JWT Bearer) in a single server and allow
routes to accept one of several schemes. This pattern lets you:

- Gradually migrate between auth types (e.g., Basic -> JWT) without breaking clients.
- Support automation (API key) and interactive users (Basic) simultaneously.
- Offer short-lived bearer tokens while retaining a fallback credential.

> When multiple schemes are specified in `-AuthorizationScheme`, the request is authorized if ANY scheme succeeds.

## Full source

File: [`pwsh/tutorial/examples/8.8-Multiple-Schemes.ps1`][8.8-Multiple-Schemes.ps1]

```powershell
{% include examples/pwsh/8.8-Multiple-Schemes.ps1 %}
```

## Step-by-step

1. Logging & server: configure a console logger and create the server.
2. Listener: bind loopback HTTPS (self-signed cert for demo). Use `-SkipCertificateCheck` in test clients.
3. Runtime: enable PowerShell runtime.
4. Basic scheme: password-based initial authentication (`BasicPS`).
5. API Key scheme: header-based key (`X-Api-Key`) for automation (`KeySimple`).
6. JWT builder: configure issuer, audience, protection (HMAC), and build once for validation parameters.
7. JWT bearer scheme: register bearer validation under name `Bearer`.
8. Enable configuration: finalize server/auth registration.
9. Secure group: under `/secure` define routes with different accepted schemes:

   - `/secure/basic` (Basic only)
   - `/secure/key` (API Key OR Basic)
   - `/secure/jwt` (JWT OR Basic)
   - `/secure/token/new` (Basic only) issues a JWT for subsequent bearer access.

10. Start server.

### Multiple scheme semantics

`Add-KrMapRoute -AuthorizationScheme 'KeySimple','BasicPS'` means:

1. Try API Key validation.
2. If it fails (no key or invalid), attempt Basic.
3. If all listed schemes fail, the route returns 401 with the challenge header(s) for the first failing scheme.

Order matters for which challenge header the client sees first; place your preferred or most common scheme first.

## Try it

Assumptions: server listening on `https://127.0.0.1:5000` with self-signed cert.

```powershell
# Basic auth header
$basic = 'Basic ' + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes('admin:password'))

# 1. Basic-only route
Invoke-RestMethod https://127.0.0.1:5000/secure/basic -SkipCertificateCheck -Headers @{ Authorization = $basic }

# 2. API Key OR Basic route (use API key)
Invoke-RestMethod https://127.0.0.1:5000/secure/key -SkipCertificateCheck -Headers @{ 'X-Api-Key' = 'my-secret-api-key' }

# 3. API Key OR Basic route (fallback to Basic)
Invoke-RestMethod https://127.0.0.1:5000/secure/key -SkipCertificateCheck -Headers @{ Authorization = $basic }

# 4. JWT OR Basic route (initially with Basic)
Invoke-RestMethod https://127.0.0.1:5000/secure/jwt -SkipCertificateCheck -Headers @{ Authorization = $basic }

# 5. Obtain JWT via token issuance (Basic required)
$token = (Invoke-RestMethod https://127.0.0.1:5000/secure/token/new -SkipCertificateCheck -Headers @{ Authorization = $basic }).access_token

# 6. Call JWT route with Bearer token
Invoke-RestMethod https://127.0.0.1:5000/secure/jwt -SkipCertificateCheck -Headers @{ Authorization = "Bearer $token" }

# 7. (Optional) Inspect token claims
Get-KrJWTInfo -Token $token | Format-List Issuer, Audience, Expires, Claims
```

> If you supply both a valid API Key and Basic header, the first listed scheme that succeeds authorizes the request.

## References

- [Add-KrBasicAuthentication][Add-KrBasicAuthentication]
- [Add-KrApiKeyAuthentication][Add-KrApiKeyAuthentication]
- [New-KrJWTBuilder][New-KrJWTBuilder]
- [Add-KrJWTIssuer][Add-KrJWTIssuer]
- [Add-KrJWTAudience][Add-KrJWTAudience]
- [Protect-KrJWT][Protect-KrJWT]
- [Build-KrJWT][Build-KrJWT]
- [Get-KrJWTValidationParameter][Get-KrJWTValidationParameter]
- [Add-KrJWTBearerAuthentication][Add-KrJWTBearerAuthentication]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Add-KrRouteGroup][Add-KrRouteGroup]
- [Copy-KrJWTTokenBuilder][Copy-KrJWTTokenBuilder]
- [Add-KrJWTSubject][Add-KrJWTSubject]
- [Add-KrJWTClaim][Add-KrJWTClaim]
- [Get-KrJWTInfo][Get-KrJWTInfo]
- [New-KrServer][New-KrServer]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Start-KrServer][Start-KrServer]

## Troubleshooting

| Symptom                      | Cause / Details                                | Fix / Guidance                                                |
| ---------------------------- | ---------------------------------------------- | ------------------------------------------------------------- |
| 401 (Basic)                  | Wrong password / header missing                | Recreate `Authorization: Basic ...` header                    |
| 401 (API Key)                | Missing/incorrect `X-Api-Key`                  | Provide correct key value                                     |
| 401 (Bearer)                 | Missing / expired / invalid JWT                | Obtain fresh token via `/secure/token/new`                    |
| Wrong challenge header shown | Less preferred scheme listed first             | Reorder names in `-AuthorizationScheme`                       |
| Claims missing in JWT        | Builder reused without copy                    | Use `Copy-KrJWTTokenBuilder` before adding per-request claims |
| Token not expiring           | No validity limiter configured                 | Add `Limit-KrJWTValidity -Minutes <n>` to builder             |
| API Key exposed in logs      | Verbose logging includes headers               | Redact or lower log verbosity for headers                     |

---

### Previous / Next

{: .fs-4 .fw-500}

- Previous: [OpenID Connect (Okta)][Prev]
- Next: [GitHub Authentication][Next]

See also: [Basic](./1.Basic-PS) · [API Key](./3.Api-Key) · [JWT](./4.Jwt) · [JWT Guide](/guides/authentication/jwt)

[8.8-Multiple-Schemes.ps1]: /pwsh/tutorial/examples/8.8-Multiple-Schemes.ps1
[Add-KrBasicAuthentication]: /pwsh/cmdlets/Add-KrBasicAuthentication
[Add-KrApiKeyAuthentication]: /pwsh/cmdlets/Add-KrApiKeyAuthentication
[New-KrJWTBuilder]: /pwsh/cmdlets/New-KrJWTBuilder
[Add-KrJWTIssuer]: /pwsh/cmdlets/Add-KrJWTIssuer
[Add-KrJWTAudience]: /pwsh/cmdlets/Add-KrJWTAudience
[Protect-KrJWT]: /pwsh/cmdlets/Protect-KrJWT
[Build-KrJWT]: /pwsh/cmdlets/Build-KrJWT
[Get-KrJWTValidationParameter]: /pwsh/cmdlets/Get-KrJWTValidationParameter
[Add-KrJWTBearerAuthentication]: /pwsh/cmdlets/Add-KrJWTBearerAuthentication
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Add-KrRouteGroup]: /pwsh/cmdlets/Add-KrRouteGroup
[Copy-KrJWTTokenBuilder]: /pwsh/cmdlets/Copy-KrJWTTokenBuilder
[Add-KrJWTSubject]: /pwsh/cmdlets/Add-KrJWTSubject
[Add-KrJWTClaim]: /pwsh/cmdlets/Add-KrJWTClaim
[Get-KrJWTInfo]: /pwsh/cmdlets/Get-KrJWTInfo
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Prev]: ./9.OpenID-Connect-Okta
[Next]: ./11.GitHub-Authentication
