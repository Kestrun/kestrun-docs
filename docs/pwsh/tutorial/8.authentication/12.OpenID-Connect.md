---
title: OpenID Connect (Duende Demo)
parent: Authentication
nav_order: 12
---

# OpenID Connect (Duende Demo)

Authenticate users via OpenID Connect using the public demo server at
[demo.duendesoftware.com](https://demo.duendesoftware.com) with PKCE,
token persistence, and a
cookie+policy scheme for clean route protection.

## Full source

File: [`pwsh/tutorial/examples/8.11-OIDC.ps1`][8.11-OIDC.ps1]

```powershell
{% include examples/pwsh/8.11-OIDC.ps1 %}
```

## Step-by-step

1. Logger: Register a console logger at Debug level.
2. Server: Create a server named "OIDC Duende Demo".
3. Listener: Bind HTTPS on loopback and port 5000 with a self-signed cert.
4. OIDC: Call `Add-KrOpenIdConnectAuthentication` (adds `Oidc`, `Oidc.Cookies`,
   and `Oidc.Policy`). Defaults to PKCE + SaveTokens. Use `-Scope` to add
   `email` or `offline_access` (for refresh tokens, if allowed).
5. Configuration: Enable the Kestrun pipeline via `Enable-KrConfiguration`.
6. Routes: Add a public landing and protected routes using `-AuthorizationScheme 'oidc'` (policy scheme forwards challenge to OIDC and authenticates via cookie).
7. Start: Run the server with `Start-KrServer`.

## Try it

```powershell
# Optional: set Duende confidential client secret (demo value is 'secret')
$env:DUENDE_CLIENT_SECRET = 'secret'

# Start sample from repo root
pwsh docs/_includes/examples/pwsh/8.11-OIDC.ps1
```

```powershell
# After login at Duende, fetch claims
Invoke-WebRequest https://localhost:5000/me -SkipCertificateCheck | Select -Expand Content
```

## Key points

- Three schemes are registered: `oidc`, `oidc.Cookies`, `oidc.Policy`.
  The policy scheme authenticates via cookies and forwards challenges to OIDC.
- PKCE and token persistence are enabled by default.
- Default scopes include `openid` and `profile`; add `email` or others with
  the `-Scope` parameter.
- Callback URL must match `https://localhost:<port><CallbackPath>`.
  Default path is `/signin-oidc`. Change it with `-CallbackPath` if needed.

## Troubleshooting

| Symptom | Cause | Resolution |
| --- | --- | --- |
| "redirect_uri not valid" | Callback mismatch | Ensure `https://localhost:5000/signin-oidc` is registered or change `-CallbackPath`. |
| Empty claims | Provider returned minimal set | Add scopes like `email`; verify `GetUserInfo` (default on). |
| Loop on challenge | Cookies blocked | Allow third-party cookies or test in a fresh profile. |

## References

- [Add-KrOpenIdConnectAuthentication][Add-KrOpenIdConnectAuthentication]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Add-KrRouteGroup][Add-KrRouteGroup]
- [New-KrServer][New-KrServer]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Start-KrServer][Start-KrServer]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Full Demo][Prev]
Next: [Full Demo][Next]

[8.11-OIDC.ps1]: /pwsh/tutorial/examples/8.11-OIDC.ps1
[Add-KrOpenIdConnectAuthentication]: /pwsh/cmdlets/Add-KrOpenIdConnectAuthentication
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Add-KrRouteGroup]: /pwsh/cmdlets/Add-KrRouteGroup
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Prev]: ./12.Full-Demo
[Next]: ./13.Full-Demo
