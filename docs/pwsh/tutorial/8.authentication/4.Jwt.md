---
title: JWT Tokens
parent: Authentication
nav_order: 4
---

# JWT Tokens

Issue and validate bearer tokens for stateless auth.

## Full source

File: [`pwsh/tutorial/examples/8.4-Jwt.ps1`][8.4-Jwt.ps1]

```powershell
{% include examples/pwsh/8.4-Jwt.ps1 %}
```

## Step-by-step

1. Logger: create console logger and register as default.
2. Server: create named server `Auth JWT`.
3. Listener: add HTTPS listener on loopback with a self-signed certificate.
4. Runtime: enable PowerShell runtime.
5. Initial auth: add Basic scheme (`BasicInit`) for first-factor credential check.
6. Build JWT config: chain issuer, audience, and HMAC protection; build & capture validation params.
7. Bearer scheme: register JWT bearer authentication using validation parameters.
8. Enable configuration: lock in server/listener/auth schemes.
9. Issue route: `/token/new` requires Basic and creates a token with subject, name and role claims.
10. Renew route: `/token/renew` (Bearer) refreshes the token using `Update-KrJWT -FromContext`.
11. Protected route: `/secure/jwt/hello` requires a valid bearer token.
12. Start server.

## Try it

```powershell
# 1. Get initial bearer token using Basic auth
$basicHeader = 'Basic ' + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes('admin:password'))
$token = (Invoke-RestMethod https://127.0.0.1:5000/token/new -SkipCertificateCheck -Headers @{ Authorization = $basicHeader }).access_token

# 2. Call protected route with current bearer token
Invoke-RestMethod https://127.0.0.1:5000/secure/jwt/hello -SkipCertificateCheck -Headers @{ Authorization = "Bearer $token" }

# 3. Renew token (issue a fresh one using existing bearer)
$refreshedToken = (Invoke-RestMethod -Uri https://localhost:5000/token/renew -SkipCertificateCheck -Headers @{ Authorization = "Bearer $token" }).access_token

# 4. Call protected route with renewed token
Invoke-RestMethod -Uri https://localhost:5000/secure/jwt/hello -SkipCertificateCheck -Headers @{ Authorization = "Bearer $refreshedToken" }

# (Optional) Inspect token (header + payload; signature not revalidated here):
Get-KrJWTInfo -Token $token | Format-List Issuer, Audience, Expires, Algorithm, Claims

# (Optional) Validate token explicitly (signature + lifetime):
Test-KrJWT -Token $token -ValidationParameter ($jwtBuilder | Build-KrJWT | Get-KrJWTValidationParameter)
```

> Note: `-SkipCertificateCheck` is used because the sample listener issues a self-signed cert. For production,
> trust the certificate or use a CA-issued cert instead.

## References

- [New-KrJWTBuilder][New-KrJWTBuilder]
- [Add-KrJWTIssuer][Add-KrJWTIssuer]
- [Add-KrJWTAudience][Add-KrJWTAudience]
- [Protect-KrJWT][Protect-KrJWT]
- [Build-KrJWT][Build-KrJWT]
- [Copy-KrJWTTokenBuilder][Copy-KrJWTTokenBuilder]
- [Add-KrJWTSubject][Add-KrJWTSubject]
- [Add-KrJWTClaim][Add-KrJWTClaim]
- [Update-KrJWT][Update-KrJWT]
- [Get-KrJWTValidationParameter][Get-KrJWTValidationParameter]
- [Add-KrJWTBearerAuthentication][Add-KrJWTBearerAuthentication]
- [Add-KrBasicAuthentication][Add-KrBasicAuthentication]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Start-KrServer][Start-KrServer]

## Troubleshooting

| Symptom              | Cause                           | Fix                                              |
| -------------------- | ------------------------------- | ------------------------------------------------ |
| 401 Bearer           | Missing or invalid token        | Provide `Authorization: Bearer <token>`          |
| Token expired        | Expiration passed               | Re-issue via `/token/new` or `/token/renew`      |
| Signature invalid    | Wrong key/algorithm             | Ensure same secret & algorithm                   |
| 401 on renew         | Missing/invalid bearer on renew | Include current valid `Authorization: Bearer`    |
| Claims not updated   | Builder not copied per request  | Use `Copy-KrJWTTokenBuilder` before adding claims |

### Previous / Next

{: .fs-4 .fw-500}

- Previous: [API Key][Prev]
- Next: [Cookies][Next]

See also: [JWT Guide](/guides/jwt) for advanced scenarios (copying builders, renewal patterns, security).

[8.4-Jwt.ps1]: /pwsh/tutorial/examples/8.4-Jwt.ps1
[New-KrJWTBuilder]: /pwsh/cmdlets/New-KrJWTBuilder
[Add-KrJWTIssuer]: /pwsh/cmdlets/Add-KrJWTIssuer
[Add-KrJWTAudience]: /pwsh/cmdlets/Add-KrJWTAudience
[Protect-KrJWT]: /pwsh/cmdlets/Protect-KrJWT
[Build-KrJWT]: /pwsh/cmdlets/Build-KrJWT
[Get-KrJWTValidationParameter]: /pwsh/cmdlets/Get-KrJWTValidationParameter
[Add-KrJWTBearerAuthentication]: /pwsh/cmdlets/Add-KrJWTBearerAuthentication
[Add-KrBasicAuthentication]: /pwsh/cmdlets/Add-KrBasicAuthentication
[Copy-KrJWTTokenBuilder]: /pwsh/cmdlets/Copy-KrJWTTokenBuilder
[Add-KrJWTSubject]: /pwsh/cmdlets/Add-KrJWTSubject
[Add-KrJWTClaim]: /pwsh/cmdlets/Add-KrJWTClaim
[Update-KrJWT]: /pwsh/cmdlets/Update-KrJWT
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Prev]: ./3.Api-Key
[Next]: ./5.Cookies
