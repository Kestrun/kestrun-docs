---
title: Claims & Policies
parent: Authentication
nav_order: 7
---

# Claims & Policies

Define claim-based authorization rules and enforce them per route. A policy maps to
required claim type(s) + allowed value(s). A route declares an `-AuthorizationPolicy`
and Kestrun validates the authenticated principal's claims before executing the
script block.

## Full source

File: [`pwsh/tutorial/examples/8.7-Claims-Policies.ps1`][8.7-Claims-Policies.ps1]

```powershell
{% include examples/pwsh/8.7-Claims-Policies.ps1 %}
```

## Step-by-step

1. Logger: (Sample defines a console logger as default; omitted here for brevity.)
2. Server: Create server named "Auth Claims".
3. Listener: Add HTTPS loopback listener with self-signed cert (port 5000).
4. Runtime: Add PowerShell runtime.
5. Policies: Build claim policy config using `New-KrClaimPolicy` piped through multiple
   `Add-KrClaimPolicy` calls (CanRead, CanWrite, CanDelete) then `Build-KrClaimPolicy`.
6. Authentication: Configure Basic auth (`Add-KrBasicAuthentication`) with validation script.
   If credentials succeed return `$true`; otherwise `$false`.
7. Issue claims: Use `-IssueClaimsScriptBlock` to emit user claims (admin gets read/write only).
8. Finalize: Apply pipeline via `Enable-KrConfiguration`.
9. Group: Secure routes with `Add-KrRouteGroup -AuthorizationSchema 'PolicyBasic' -Prefix '/policy'`.
10. Routes: Add route handlers each specifying an `-AuthorizationPolicy`.
11. Start: Run the server with `Start-KrServer`.

### Policy structure

Each `Add-KrClaimPolicy` defines:

- PolicyName: symbolic name used by routes (e.g., `CanRead`).
- ClaimType: the claim key to check (e.g., `can_read`).
- AllowedValues: one or more acceptable values (here just `'true'`).

All claim requirements for a single policy must pass (logical AND if future enhancements add multiple claims per policy).

### Claim issuance

The `-IssueClaimsScriptBlock` receives the identity _after_ successful authentication. It returns one or more
`Add-KrUserClaim` objects piped together. In the sample only `admin` receives
`can_read` and `can_write`; no claim is issued for `can_delete`, so the `Delete`
policy will fail for this user.

### Auth vs authorization codes

- 401 Unauthorized: Authentication failed or missing (e.g., wrong Basic credentials).
- 403 Forbidden: Authenticated but lacks required claim/policy.

## Try it

```powershell
# Helper: build Basic header for admin
$b = 'Basic ' + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes('admin:password'))

# 1) Read (should succeed)
Invoke-WebRequest https://127.0.0.1:5000/policy/read -Headers @{ Authorization = $b } -SkipCertificateCheck | Select -Expand Content

# 2) Write (should succeed; claim can_write=true)
Invoke-WebRequest https://127.0.0.1:5000/policy/write -Headers @{ Authorization = $b } -SkipCertificateCheck | Select -Expand Content

# 3) Delete (should 403; no can_delete claim)
try { Invoke-WebRequest https://127.0.0.1:5000/policy/delete -Headers @{ Authorization = $b } -SkipCertificateCheck -ErrorAction Stop }
catch { $_.Exception.Response.StatusCode }

# 4) Missing/invalid credentials (401 then 403 scenario)
$bad = 'Basic ' + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes('user:wrong'))
try { Invoke-WebRequest https://127.0.0.1:5000/policy/read -Headers @{ Authorization = $bad } -SkipCertificateCheck -ErrorAction Stop }
catch { $_.Exception.Response.StatusCode }
```

## References

- [New-KrClaimPolicy][New-KrClaimPolicy]
- [Add-KrClaimPolicy][Add-KrClaimPolicy]
- [Build-KrClaimPolicy][Build-KrClaimPolicy]
- [Add-KrBasicAuthentication][Add-KrBasicAuthentication]
- [Add-KrUserClaim][Add-KrUserClaim]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Add-KrRouteGroup][Add-KrRouteGroup]
- [New-KrServer][New-KrServer]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Start-KrServer][Start-KrServer]
- [Write-KrLog][Write-KrLog]

## Troubleshooting

| Symptom                | Cause                              | Fix / Action                                 |
| ---------------------- | ---------------------------------- | -------------------------------------------- |
| 403 Forbidden          | Required claim missing             | Check issue script; confirm claim type/value |
| 401 then 403 sequence  | First request unauthenticated      | Add / correct Basic header                   |
| Policy always failing  | Policy name mismatch in route      | Match `-AuthorizationPolicy` with PolicyName |
| All routes 401         | Basic auth script returns `$false` | Verify credentials logic                     |
| Delete unexpectedly OK | Claim accidentally issued          | Inspect `-IssueClaimsScriptBlock` output     |
| Write unexpectedly 403 | Claim type spelling mismatch       | Align claim type in policy vs issued claims  |

## Security notes

- Basic auth transmits credentials base64-encoded â€” always use HTTPS (self-signed is fine locally).
- Avoid hard-coded credentials in production; integrate with a user store.
- Claims represent authorization decisions; avoid over-granting (principle of least privilege).
- Log authentication attempts (sample uses `Write-KrLog`). Consider separating audit sink.
- Do not leak claim names or sensitive values in error details returned to clients.

---

### Previous / Next

- Previous: [Windows Authentication][Prev]
- Next: [Multiple Schemes][Next]

[8.7-Claims-Policies.ps1]: /pwsh/tutorial/examples/8.7-Claims-Policies.ps1
[New-KrClaimPolicy]: /pwsh/cmdlets/New-KrClaimPolicy
[Add-KrClaimPolicy]: /pwsh/cmdlets/Add-KrClaimPolicy
[Add-KrBasicAuthentication]: /pwsh/cmdlets/Add-KrBasicAuthentication
[Build-KrClaimPolicy]: /pwsh/cmdlets/Build-KrClaimPolicy
[Add-KrUserClaim]: /pwsh/cmdlets/Add-KrUserClaim
[Add-KrRouteGroup]: /pwsh/cmdlets/Add-KrRouteGroup
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Write-KrLog]: /pwsh/cmdlets/Write-KrLog
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Prev]: ./6.Windows-Authentication
[Next]: ./8.Multiple-Schemes
