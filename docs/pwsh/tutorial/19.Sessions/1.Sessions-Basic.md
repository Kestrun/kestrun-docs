---
parent: Sessions
title: Basic Sessions
nav_order: 1
---

# Basic Sessions

Use cookie-based session state to persist small key-value data across requests (counters, user info, preferences).

## Full source

File: [`pwsh/tutorial/examples/19.1-Sessions.ps1`][19.1-Sessions.ps1]

```powershell
{% include examples/pwsh/19.1-Sessions.ps1 %}
```

## Step-by-step

1. Logging: Register a console logger and set level to Debug.
2. Server: Create a Kestrun server named "Sessions Demo Server".
3. Listener: Listen on loopback using a self-signed certificate on the provided port (HTTPS).
4. Cookie: Build a secure session cookie (`Kr.Session`) with HttpOnly, SameSite=Lax, and SecurePolicy=Always.
5. Session: Enable session services and middleware with idle (20s) and I/O (10s) timeouts.
6. Configure: Call `Enable-KrConfiguration` to build the app.
7. Routes: Map endpoints for counter, login, whoami, logout, set, and get using session cmdlets.
8. Start: Run the server asynchronously with `Start-KrServer`.

## Try it

Because this sample uses a self-signed certificate and a Secure cookie, use HTTPS and skip certificate verification during local testing.

```powershell
# In another shell, use curl with a cookie jar to preserve session
$base = 'https://127.0.0.1:8080'

# Counter increments with the same cookie jar
curl -k -s -c jar.txt -b jar.txt "$base/session/counter" | jq
curl -k -s -c jar.txt -b jar.txt "$base/session/counter" | jq

# WhoAmI requires login
curl -k -s -c jar.txt -b jar.txt -i "$base/session/whoami"

# Login and read identity
curl -k -s -c jar.txt -b jar.txt "$base/session/login?user=max" | jq
curl -k -s -c jar.txt -b jar.txt "$base/session/whoami" | jq

# Generic set/get within the same session
curl -k -s -c jar.txt -b jar.txt "$base/session/set?key=color&value=purple" | jq
curl -k -s -c jar.txt -b jar.txt "$base/session/get?key=color" | jq

# Logout clears the session
curl -k -s -c jar.txt -b jar.txt "$base/session/logout" | jq
curl -k -s -c jar.txt -b jar.txt -i "$base/session/whoami"
```

PowerShell equivalents (Invoke-WebRequest):

```powershell
$base = 'https://127.0.0.1:8080'
$sess = New-Object Microsoft.PowerShell.Commands.WebRequestSession

# Counter increments with the same WebRequestSession
((Invoke-WebRequest -Uri "$base/session/counter" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json).counter
((Invoke-WebRequest -Uri "$base/session/counter" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json).counter

# WhoAmI requires login (expected 401 before login)
try {
    Invoke-WebRequest -Uri "$base/session/whoami" -WebSession $sess -SkipCertificateCheck -ErrorAction Stop | Out-Null
} catch {
    'status: 401 (unauthorized)'
}

# Login and read identity
Invoke-WebRequest -Uri "$base/session/login?user=max" -WebSession $sess -SkipCertificateCheck | Out-Null
(Invoke-WebRequest -Uri "$base/session/whoami" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json

# Generic set/get within the same session
Invoke-WebRequest -Uri "$base/session/set?key=color&value=purple" -WebSession $sess -SkipCertificateCheck | Out-Null
(Invoke-WebRequest -Uri "$base/session/get?key=color" -WebSession $sess -SkipCertificateCheck).Content | ConvertFrom-Json

# Logout clears the session
Invoke-WebRequest -Uri "$base/session/logout" -WebSession $sess -SkipCertificateCheck | Out-Null
try {
    Invoke-WebRequest -Uri "$base/session/whoami" -WebSession $sess -SkipCertificateCheck -ErrorAction Stop | Out-Null
} catch {
    'status: 401 (unauthorized)'
}
```

> Tip: Use a different cookie jar file (or clear it) to simulate a new browser session.

## Key Points

- Sessions are cookie-based and intended for small data; prefer a distributed cache for larger workloads.
- The sample defaults to an in-memory distributed cache; you can bring your own Redis/SQL provider.
- Configure cookies with Secure, HttpOnly, and SameSite for better security.
- Session middleware must run before routes that rely on it; `Add-KrSession` wires services + middleware.

## Troubleshooting

- 401 on /session/whoami: You must call `/session/login?user=NAME` first in the same session (preserve cookies).
- Cookie not sticking: Ensure you use HTTPS (Secure cookie) or change `-SecurePolicy None` for plain HTTP testing.
- 404 on /session/get: The key may not be set in this session; use `/session/set?key=...&value=...` first.
- Unexpected resets: Very short `-IdleTimeout` will abandon sessions; increase it for interactive testing.

## References

- [Add-KrSession][Add-KrSession]
- [New-KrCookieBuilder][New-KrCookieBuilder]
- [Get-KrSessionInt32][Get-KrSessionInt32]
- [Set-KrSessionInt32][Set-KrSessionInt32]
- [Get-KrSessionString][Get-KrSessionString]
- [Set-KrSessionString][Set-KrSessionString]
- [Clear-KrSession][Clear-KrSession]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Write-KrJsonResponse][Write-KrJsonResponse]
- [Write-KrTextResponse][Write-KrTextResponse]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Start-KrServer][Start-KrServer]
- [Sessions Guide][Sessions Guide]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Exception Handling](../18.ExceptionHandling/index)
Next: [Sessions with Redis](./2.Sessions-Redis)

[19.1-Sessions.ps1]: /pwsh/tutorial/examples/19.1-Sessions.ps1
[Add-KrSession]: /pwsh/cmdlets/Add-KrSession
[New-KrCookieBuilder]: /pwsh/cmdlets/New-KrCookieBuilder
[Get-KrSessionInt32]: /pwsh/cmdlets/Get-KrSessionInt32
[Set-KrSessionInt32]: /pwsh/cmdlets/Set-KrSessionInt32
[Get-KrSessionString]: /pwsh/cmdlets/Get-KrSessionString
[Set-KrSessionString]: /pwsh/cmdlets/Set-KrSessionString
[Clear-KrSession]: /pwsh/cmdlets/Clear-KrSession
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
[Write-KrTextResponse]: /pwsh/cmdlets/Write-KrTextResponse
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Sessions Guide]: /guides/sessions
