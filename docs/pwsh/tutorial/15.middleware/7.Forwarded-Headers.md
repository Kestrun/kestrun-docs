---
title: Forwarded Headers
parent: Middleware
nav_order: 7
---

# Forwarded Headers

Honor X-Forwarded-* headers from a reverse proxy to reflect the original client IP, scheme, and host.

## Full source

File: [`pwsh/tutorial/examples/15.7-Forwarded-Header.ps1`][15.7-Forwarded-Header.ps1]

```powershell
{% include examples/pwsh/15.7-Forwarded-Header.ps1 %}
```

## Step-by-step

1. Logging: Register a console logger at Debug and set it as default.
2. Server: Create a server named 'Forwarded Headers Demo'.
3. Middleware: Add forwarded headers with `Add-KrForwardedHeader` to process `X-Forwarded-For`, `X-Forwarded-Proto`, and `X-Forwarded-Host`.
4. Trust: For local testing, trust loopback proxies so forwarded headers are honored.
5. Listener: Expose an HTTP listener on the configured port and IP.
6. Configuration: Call `Enable-KrConfiguration` to finalize middleware.
7. Route: Map `/forward` to return `scheme`, `host`, and `remoteIp` (after forwarding is applied).
8. Start: Run `Start-KrServer` to start the server.

## Try it

Start the sample (default port 5000):

```powershell
pwsh ./docs/_includes/examples/pwsh/15.7-Forwarded-Header.ps1
```

Send a request simulating a reverse proxy:

```bash
curl -s http://127.0.0.1:5000/forward \
  -H "X-Forwarded-For: 203.0.113.9" \
  -H "X-Forwarded-Proto: https" \
  -H "X-Forwarded-Host: proxy.example.test" | jq
```

PowerShell equivalent:

```powershell
Invoke-WebRequest http://127.0.0.1:5000/forward -Headers @{
  'X-Forwarded-For'='203.0.113.9'; 'X-Forwarded-Proto'='https'; 'X-Forwarded-Host'='proxy.example.test'
} | ForEach-Object { $_.Content }
```

Expected JSON (values depend on headers):

```json
{
  "scheme": "https",
  "host": "proxy.example.test",
  "remoteIp": "203.0.113.9"
}
```

## Key Points

- Place forwarded headers early in the pipeline (before enabling configuration) so it applies to subsequent routing.
- In production, restrict `KnownProxies`/`KnownNetworks` to trusted proxy addresses or ranges.
- Supported flags include `XForwardedFor`, `XForwardedProto`, `XForwardedHost`, and `XForwardedPathBase`.
- `ForwardLimit` controls how many `X-Forwarded-For` entries are considered.

## Troubleshooting

| Symptom | Likely cause | Fix |
|---------|--------------|-----|
| Request.Scheme stays `http` | Middleware registered too late | Call `Add-KrForwardedHeader` before `Enable-KrConfiguration` and before adding routes. |
| Host remains `localhost:port` | Proxy not trusted or host rewriting disabled | Ensure loopback or your proxy IPs are in `-KnownProxies`/`-KnownNetworks`. Include `X-Forwarded-Host` in `-ForwardedHeaders`. |
| `RemoteIpAddress` is `$null` | `X-Forwarded-For` not considered or exceeded `ForwardLimit` | Include `XForwardedFor` flag and set `-ForwardLimit 1` (or appropriate value). |
| Works with curl but fails in browser | Browser/proxy strips headers | Verify actual headers on the wire; use devtools or a proxy tool. |
| Mixed proxy chains | Multiple entries in `X-Forwarded-For` | Increase `-ForwardLimit` and enumerate `KnownNetworks`/`KnownProxies` accordingly. |

## References

- Guide: [Forwarded Headers][ForwardedHeadersTopic]
- [Add-KrForwardedHeader][Add-KrForwardedHeader]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Start-KrServer][Start-KrServer]
- [Write-KrJsonResponse][Write-KrJsonResponse]
- [New-KrLogger][New-KrLogger]
- [Set-KrLoggerLevel][Set-KrLoggerLevel]
- [Add-KrSinkConsole][Add-KrSinkConsole]
- [Register-KrLogger][Register-KrLogger]
- [RoutingTopic][RoutingTopic]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Host Filtering](./6.Host-Filtering)
Next: _None_

[15.7-Forwarded-Header.ps1]: /pwsh/tutorial/examples/15.7-Forwarded-Header.ps1
[Add-KrForwardedHeader]: /pwsh/cmdlets/Add-KrForwardedHeader
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
[New-KrLogger]: /pwsh/cmdlets/New-KrLogger
[Set-KrLoggerLevel]: /pwsh/cmdlets/Set-KrLoggerLevel
[Add-KrSinkConsole]: /pwsh/cmdlets/Add-KrSinkConsole
[Register-KrLogger]: /pwsh/cmdlets/Register-KrLogger
[RoutingTopic]: /guides/routing
[ForwardedHeadersTopic]: /guides/forwardedheaders
