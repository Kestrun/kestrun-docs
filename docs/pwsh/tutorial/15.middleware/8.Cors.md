---
title: CORS
parent: Middleware
nav_order: 8
---

# CORS

Configure Cross-Origin Resource Sharing (CORS) policies to control browser access from different origins.

## Full source

File: [`pwsh/tutorial/examples/15.8-Cors-Multipolicy.ps1`][15.8-Cors-Multipolicy.ps1]

```powershell
{% include examples/pwsh/15.8-Cors-Multipolicy.ps1 %}
```

## Step-by-step

1. **Logger**: Register console logger with debug level to observe CORS-related requests.
2. **Server**: Create server and configure OpenAPI metadata for the multi-policy sample.
3. **Default policy**: Define a default CORS policy allowing UI origin for GET requests only.
4. **Named policies**: Create three specialized policies:
   - `PublicRead`: Allows UI origin for catalog operations
   - `PartnerOnly`: Restricts access to partner origin only (UI will fail)
   - `AdminWrite`: Permits write operations (POST/DELETE) with preflight support
5. **API routes**: Register OpenAPI operations with specific CORS policies via `CorsPolicy` parameter.
6. **UI test page**: Add an HTML endpoint serving a browser-based test interface.
7. **Documentation routes**: Enable OpenAPI spec and multiple documentation UIs.
8. **Start**: Launch server and test CORS behaviors from the browser UI.

## Try it

Start the server:

```powershell
.\15.8-Cors-Multipolicy.ps1 -Port 5000
```

Open the test UI in a browser:

```powershell
Start-Process "http://localhost:5000"
```

Test individual endpoints with curl (note: curl doesn't enforce CORS, browsers do):

```powershell
# List products (PublicRead policy allows this)
curl -i http://localhost:5000/products

# Get partner inventory (requires partner origin, curl bypasses CORS)
curl -i http://localhost:5000/partner/inventory

# Create order (AdminWrite policy, triggers preflight in browsers)
curl -i -X POST http://localhost:5000/orders `
  -H "Content-Type: application/json" `
  -d '{"productId":1}'

# Test endpoint without explicit CORS policy
curl -i http://localhost:5000/nocors
```

View the OpenAPI specification:

```powershell
curl http://localhost:5000/openapi/v1/openapi.json
```

## CORS concepts

### Origins and policies

CORS policies control which origins can access your API from a browser. An origin consists of scheme, host, and port (e.g., `http://localhost:5000`).

**Default policy**: Applies to routes without explicit policy assignment.

**Named policies**: Create granular control for different route groups:

- Read-only access for public catalog
- Partner-specific access with different origin
- Write operations requiring preflight validation

### Preflight requests

Browsers send OPTIONS requests before certain cross-origin operations:

- Non-simple methods (POST, PUT, DELETE)
- Custom headers
- Content-Type other than form-encoded

The `AdminWrite` policy demonstrates preflight handling for POST and DELETE operations.

You can reduce preflight frequency by setting a max age:

```powershell
New-KrCorsPolicyBuilder |
  Set-KrCorsOrigin -Origins 'http://localhost:3000' |
  Set-KrCorsMethod -Methods GET, POST, DELETE |
  Set-KrCorsHeader -Any |
  Set-KrCorsPreflightMaxAge -Seconds 7200 |
  Add-KrCorsPolicy -Name 'WithMaxAge'
```

### Policy builder

Use the fluent builder pattern to construct policies:

```powershell
New-KrCorsPolicyBuilder |
    Set-KrCorsOrigin -Origins 'http://localhost:5000' |
    Set-KrCorsMethod -Methods GET, POST |
    Set-KrCorsHeader -Any |
    # Expose custom headers so browsers can read them
    Set-KrCorsExposedHeader -Headers 'X-Total-Count','X-Page-Number' |
    # Cache browser preflight for 2 hours
    Set-KrCorsPreflightMaxAge -Seconds 7200 |
    Add-KrCorsPolicy -Name 'MyPolicy'
```

### Route assignment

Assign policies to individual operations:

```powershell
function listProducts {
    [OpenApiPath(HttpVerb = 'Get', Pattern = '/products', CorsPolicy = 'PublicRead')]
    param()
    Write-KrJsonResponse -StatusCode 200 -InputObject $Products
}
```

## Key points

- **Origin matching is exact**: `http://localhost:5000` â‰  `http://127.0.0.1:5000`
- **CORS is browser-enforced**: Tools like curl bypass CORS restrictions
- **Test with real browsers**: Use the included UI test page to verify CORS behaviors
- **Preflight caching**: Browsers cache preflight responses to reduce overhead
- **Default policy fallback**: Routes without explicit policy use the default policy

## Troubleshooting

**CORS errors in browser console**: Check that the Origin header matches allowed origins exactly.

**Preflight failures**: Ensure write operations (POST/PUT/DELETE) have appropriate policy allowing those methods.

**Missing CORS headers**: Verify `Add-KrCorsPolicy` was called with correct policy name.

**Partner-only route fails**: The `PartnerOnly` policy intentionally rejects UI origin to demonstrate policy isolation.

## References

- [New-KrCorsPolicyBuilder][New-KrCorsPolicyBuilder]
- [Set-KrCorsOrigin][Set-KrCorsOrigin]
- [Set-KrCorsMethod][Set-KrCorsMethod]
- [Set-KrCorsHeader][Set-KrCorsHeader]
- [Set-KrCorsExposedHeader][Set-KrCorsExposedHeader]
- [Set-KrCorsPreflightMaxAge][Set-KrCorsPreflightMaxAge]
- [Add-KrCorsPolicy][Add-KrCorsPolicy]
- [Add-KrMapRoute][Add-KrMapRoute]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Forwarded Headers](./7.Forwarded-Headers)
Next: _None_

[15.8-Cors-Multipolicy.ps1]: https://github.com/Kestrun/Kestrun/blob/main/docs/_includes/examples/pwsh/15.8-Cors-Multipolicy.ps1
[New-KrCorsPolicyBuilder]: /pwsh/cmdlets/New-KrCorsPolicyBuilder
[Set-KrCorsOrigin]: /pwsh/cmdlets/Set-KrCorsOrigin
[Set-KrCorsMethod]: /pwsh/cmdlets/Set-KrCorsMethod
[Set-KrCorsHeader]: /pwsh/cmdlets/Set-KrCorsHeader
[Set-KrCorsExposedHeader]: /pwsh/cmdlets/Set-KrCorsExposedHeader
[Set-KrCorsPreflightMaxAge]: /pwsh/cmdlets/Set-KrCorsPreflightMaxAge
[Add-KrCorsPolicy]: /pwsh/cmdlets/Add-KrCorsPolicy
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
