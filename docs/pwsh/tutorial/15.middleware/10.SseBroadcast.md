---
title: SSE Broadcast
parent: Middleware
nav_order: 10
layout: default
---

# SSE Broadcast

Keep an SSE connection open and broadcast events to all connected clients.

## Full source

File: [`pwsh/tutorial/examples/15.10-SseBroadcast.ps1`][15.10-SseBroadcast.ps1]

```powershell
{% include examples/pwsh/15.10-SseBroadcast.ps1 %}
```

## Step-by-step

1. Logging: Register a console logger as default.
2. Server: Create a server and listener (IP + port).
3. Broadcast SSE: Add `Add-KrSseBroadcastMiddleware` to expose `/sse/broadcast`.
4. Configuration: Enable configuration so middleware and routes are active.
5. Home page: Serve an HTML demo with an `EventSource('/sse/broadcast')` client.
6. Broadcast API: Implement `POST /api/broadcast` to accept `{ event, data }` JSON.
7. Broadcast: Send events to all clients using `Send-KrSseBroadcastEvent`.
8. Run: Start the server, connect clients, then broadcast messages.

## Try it

Start the server:

```powershell
pwsh .\docs\_includes\examples\pwsh\15.10-SseBroadcast.ps1
```

Open the demo UI and connect:

```powershell
Start-Process http://127.0.0.1:5000/
```

Broadcast a message via the API:

```powershell
curl -i -X POST http://127.0.0.1:5000/api/broadcast \
  -H "Content-Type: application/json" \
  -d "{\"event\":\"message\",\"data\":{\"text\":\"hello\"}}"
```

## Troubleshooting

| Symptom | Cause | Fix |
|--------|-------|-----|
| SSE stream never shows events | No clients connected | Connect a client to `/sse/broadcast` before broadcasting. |
| Broadcast API returns 500 | Bad JSON body | Ensure `Content-Type: application/json` and send `{ event, data }`. |
| Browser reconnect loop | Connection interrupted | Check proxies/load balancers; increase `-KeepAliveSeconds` to keep intermediaries from timing out. |

## References

- [Add-KrSseBroadcastMiddleware][Add-KrSseBroadcastMiddleware]
- [Send-KrSseBroadcastEvent][Send-KrSseBroadcastEvent]
- [Get-KrSseConnectedClientCount][Get-KrSseConnectedClientCount]
- [Get-KrRequestBody][Get-KrRequestBody]
- [Write-KrJsonResponse][Write-KrJsonResponse]
- [Write-KrHtmlResponse][Write-KrHtmlResponse]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Start-KrServer][Start-KrServer]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [SSE](./9.Sse)
Next: _None_

[15.10-SseBroadcast.ps1]: /pwsh/tutorial/examples/15.10-SseBroadcast.ps1
[Add-KrSseBroadcastMiddleware]: /pwsh/cmdlets/Add-KrSseBroadcastMiddleware
[Send-KrSseBroadcastEvent]: /pwsh/cmdlets/Send-KrSseBroadcastEvent
[Get-KrSseConnectedClientCount]: /pwsh/cmdlets/Get-KrSseConnectedClientCount
[Get-KrRequestBody]: /pwsh/cmdlets/Get-KrRequestBody
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
[Write-KrHtmlResponse]: /pwsh/cmdlets/Write-KrHtmlResponse
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
