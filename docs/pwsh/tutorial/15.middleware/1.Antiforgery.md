---
title: Antiforgery Protection
parent: Middleware
nav_order: 1
---

# Antiforgery Protection

Protect state‑changing endpoints (POST/PUT/PATCH/DELETE) from Cross-Site Request Forgery by validating a token that is *bound* to a user session cookie.

The antiforgery middleware issues:

| Artifact | Default (sample) | Purpose |
|----------|------------------|---------|
| Cookie   | `.Kestrun.AntiXSRF` | Stores the cryptographic token (HttpOnly, Secure, SameSite=Lax) |
| Header   | `X-CSRF-TOKEN`      | Client echoes the request (header value) for unsafe verbs |
| Endpoint | `/csrf-token`       | Returns a fresh token for single-page apps / JS fetch |

> Safe verbs (GET, HEAD, OPTIONS, TRACE) do not require the header. Only *unsafe* verbs modifying server state are validated.

## Full source

Sample script: [`pwsh/tutorial/examples/15.1-Antiforgery.ps1`][sc-mw-antiforgery]

```powershell
{% include examples/pwsh/15.1-Antiforgery.ps1 %}
```

## Step-by-step

1. Add middleware and token endpoint early in configuration.
2. Client fetches `/csrf-token`; server issues antiforgery cookie + returns token.
3. For unsafe verbs (POST/PUT/PATCH/DELETE), client includes both cookie and `X-CSRF-TOKEN` header.
4. Middleware validates that the header token matches the cookie context.
5. If valid → request proceeds; if missing/invalid → 400/403 rejection.
6. Safe verbs (GET/HEAD/OPTIONS/TRACE) and routes with `-DisableAntiforgery` skip validation.

## Configuration

Add the middleware early (after runtime) and optionally customize names:

```powershell
Add-KrAntiforgeryMiddleware -CookieName '.Kestrun.AntiXSRF' -HeaderName 'X-CSRF-TOKEN'
Add-KrAntiforgeryTokenRoute -Path '/csrf-token' | Out-Null
```

Disable antiforgery per route when appropriate (e.g., read-only JSON echo):

```powershell
$options = [Kestrun.Hosting.Options.MapRouteOptions]::new()
$options.Pattern = '/json'
$options.HttpVerbs = [Kestrun.Utilities.HttpVerb[]] @('get')
$options.Code = {
    $message = Get-KrRequestHeader -Name 'message'
    Write-KrJsonResponse -InputObject @{ message = $message } -StatusCode 200
}
$options.Language = 'PowerShell'
$options.DisableAntiforgery = $true
Add-KrMapRoute -Options $options
```

## Try it

The sample defines multiple routes; below we exercise each type (safe GETs, opt-out GET, protected POST success/failure).

```powershell
# 1. Explore SAFE GET routes (no antiforgery header required)
Invoke-RestMethod -Uri https://127.0.0.1:5000/hello -SkipCertificateCheck
Invoke-RestMethod -Uri https://127.0.0.1:5000/hello-json -SkipCertificateCheck
Invoke-RestMethod -Uri https://127.0.0.1:5000/hello-xml -SkipCertificateCheck -Headers @{ 'Accept' = 'application/xml' }
Invoke-RestMethod -Uri https://127.0.0.1:5000/hello-yaml -SkipCertificateCheck -Headers @{ 'Accept' = 'application/x-yaml' }

# 2. Call the /json route (explicitly opted out via DisableAntiforgery)
Invoke-RestMethod -Uri 'https://127.0.0.1:5000/json?message=Ping' -SkipCertificateCheck

# 3. Fetch a CSRF token (sets cookie + returns token JSON)
$response = Invoke-WebRequest -Uri https://127.0.0.1:5000/csrf-token -SessionVariable sess -SkipCertificateCheck
$token = ($response.Content | ConvertFrom-Json).token

# (Optional) Inspect session cookie name/value
$sess.Cookies.GetCookies('https://127.0.0.1:5000') | Where-Object { $_.Name -like '*AntiXSRF' } | Format-List *

# 4. Protected POST SUCCESS (token + cookie)
Invoke-RestMethod -Uri https://127.0.0.1:5000/profile -Method Post -WebSession $sess -SkipCertificateCheck -Headers @{ 'X-CSRF-TOKEN' = $token } -Body '{"name":"Alice"}' -ContentType 'application/json'

# Create a new session for the second request (to simulate a separate request with same cookie) but not the header
$sess2 = New-Object Microsoft.PowerShell.Commands.WebRequestSession
$sess2.Cookies = $sess.Cookies   # copy cookie container reference

# 5. Protected POST FAILURE (missing header) – expect 400/403
Invoke-RestMethod -Uri https://127.0.0.1:5000/profile -Method Post -WebSession $sess2 -SkipCertificateCheck -Body '{"name":"Bob"}' -ContentType 'application/json' -SkipHttpErrorCheck

# 6. (Optional) Re-fetch token to demonstrate rotation / idempotence
Invoke-RestMethod -Uri https://127.0.0.1:5000/csrf-token -WebSession $sess -SkipCertificateCheck
```

## Security Notes

| Concern | Guidance |
|---------|----------|
| SameSite | `Lax` is balanced for typical form/SPA flows. Use `Strict` if you do not rely on cross-site top-level navigation. |
| HTTPS    | Always serve antiforgery cookies over TLS in production (`Secure` flag). |
| Token Leakage | Never log raw tokens. Treat them as secrets while valid. |
| Read-Only APIs | For pure JSON GET APIs, antiforgery adds no value—focus on auth instead. |
| APIs with Bearer Tokens | If you ONLY accept Bearer tokens (no cookies), antiforgery is usually unnecessary. |

Need more depth (architecture, SPA patterns, form integration)? See the **[Antiforgery Deep Dive](/guides/antiforgery)** guide page.

## Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| 400/403 on POST | Missing header | Include `X-CSRF-TOKEN` with value from `/csrf-token` endpoint |
| Token rotates unexpectedly | Browser clearing cookies or domain mismatch | Check cookie domain/path and dev tools storage |
| Works in curl but not browser | Header not set by frontend HTTP client | Ensure JS fetch/axios includes custom header |
| Token endpoint not found | Token route not added | Call `Add-KrAntiforgeryTokenRoute` before `Start-KrServer` |
| Route unexpectedly bypassed | `-DisableAntiforgery` set | Remove flag for protected endpoints |

## References

- [Add-KrAntiforgeryMiddleware][Add-KrAntiforgeryMiddleware]
- [Add-KrAntiforgeryTokenRoute][Add-KrAntiforgeryTokenRoute]
- [Add-KrMapRoute][Add-KrMapRoute]
- [OWASP][OWASP]

---

Return to the [Middleware index](./index) or the [Tutorial index](/pwsh/tutorial/index).

[sc-mw-antiforgery]: /pwsh/tutorial/examples/15.1-Antiforgery.ps1

[Add-KrAntiforgeryMiddleware]: /pwsh/cmdlets/Add-KrAntiforgeryMiddleware
[Add-KrAntiforgeryTokenRoute]: /pwsh/cmdlets/Add-KrAntiforgeryTokenRoute
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[OWASP]: https://owasp.org/www-community/attacks/csrf

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Lifecycle](../14.lifecycle/index)
Next: [Response Compression](./2.Compression)
